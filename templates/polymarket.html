{% extends "base.html" %}

{% block title %}HELIOS - Trading{% endblock %}

{% block head_extra %}
<style>
    /* ============= PAGE LAYOUT ============= */
    .pm-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .pm-select {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 8px 12px;
        font-size: 13px;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
    }
    .pm-select:focus { outline: none; border-color: var(--accent-blue); }
    .pm-day-toggle {
        display: flex;
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 8px;
        overflow: hidden;
    }
    .pm-day-btn {
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .pm-day-btn.active {
        background: rgba(0,120,255,0.2);
        color: var(--accent-blue);
    }
    .pm-ws-badge {
        font-size: 10px;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    .pm-ws-badge.connected {
        background: rgba(16,185,129,0.15);
        color: #10B981;
        border: 1px solid rgba(16,185,129,0.3);
    }
    .pm-ws-badge.disconnected {
        background: rgba(239,68,68,0.15);
        color: #EF4444;
        border: 1px solid rgba(239,68,68,0.3);
    }

    /* ============= OVERVIEW CARD ============= */
    .pm-overview {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
    }
    .pm-overview-left {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .pm-event-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .pm-event-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 12px;
        color: var(--text-secondary);
    }
    .pm-volume {
        font-weight: 700;
        color: var(--accent-green);
    }
    .pm-status-badge {
        font-size: 10px;
        padding: 3px 10px;
        border-radius: 20px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    .pm-status-badge.open {
        background: rgba(16,185,129,0.15);
        color: #10B981;
        border: 1px solid rgba(16,185,129,0.3);
    }
    .pm-status-badge.mature {
        background: rgba(244,208,63,0.15);
        color: #F4D03F;
        border: 1px solid rgba(244,208,63,0.3);
    }
    .pm-status-badge.closed {
        background: rgba(239,68,68,0.15);
        color: #EF4444;
        border: 1px solid rgba(239,68,68,0.3);
    }
    .pm-overview-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }
    .pm-sentiment {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .pm-sentiment.shifting { color: #F4D03F; }
    .pm-sentiment.aggressive { color: #EF4444; }

    /* ============= TRADING SIGNAL ============= */
    .pm-trading {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 20px;
    }
    .pm-trading-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 14px;
        margin-bottom: 16px;
    }
    .pm-trade-card {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 16px;
        background: rgba(255,255,255,0.015);
        min-height: 132px;
    }
    .pm-trade-card.good {
        border-color: rgba(16,185,129,0.22);
        background: rgba(16,185,129,0.05);
    }
    .pm-trade-card.watch {
        border-color: rgba(244,208,63,0.20);
        background: rgba(244,208,63,0.04);
    }
    .pm-trade-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 700;
    }
    .pm-trade-main {
        font-size: 24px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
        color: var(--text-primary);
        line-height: 1.05;
    }
    .pm-trade-sub {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
        line-height: 1.45;
    }
    .pm-trade-pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    .pm-trade-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 700;
        border: 1px solid rgba(255,255,255,0.08);
        background: rgba(255,255,255,0.04);
        color: var(--text-secondary);
    }
    .pm-trade-pill.buy {
        color: #10B981;
        border-color: rgba(16,185,129,0.22);
        background: rgba(16,185,129,0.10);
    }
    .pm-trade-pill.up {
        color: #10B981;
        border-color: rgba(16,185,129,0.22);
        background: rgba(16,185,129,0.10);
    }
    .pm-trade-pill.down {
        color: #EF4444;
        border-color: rgba(239,68,68,0.22);
        background: rgba(239,68,68,0.10);
    }
    .pm-trade-pill.flat {
        color: #cbd5e1;
    }
    .pm-trading-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .pm-trading-table th {
        text-align: left;
        padding: 8px 10px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 10px;
        letter-spacing: 1px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .pm-trading-table td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .pm-edge-positive { color: #10B981; font-weight: 700; }
    .pm-edge-neutral { color: var(--text-secondary); }
    .pm-autotrader {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 14px;
        background: rgba(255,255,255,0.02);
        margin-bottom: 14px;
    }
    .pm-autotrader-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
    }
    .pm-autotrader-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    .pm-autotrader-main {
        font-size: 22px;
        font-weight: 800;
        color: #fff;
    }
    .pm-autotrader-sub {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.5;
    }
    .pm-autotrader-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .pm-autotrader-btn {
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
        color: #fff;
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
    }
    .pm-autotrader-btn.primary {
        border-color: rgba(16,185,129,0.35);
        background: rgba(16,185,129,0.12);
        color: #10B981;
    }
    .pm-autotrader-btn.danger {
        border-color: rgba(239,68,68,0.35);
        background: rgba(239,68,68,0.10);
        color: #F87171;
    }
    .pm-autotrader-btn:disabled {
        opacity: 0.45;
        cursor: default;
    }
    .pm-autotrader-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
        margin-bottom: 12px;
    }
    .pm-autotrader-cell {
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(255,255,255,0.02);
    }
    .pm-autotrader-cell-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    .pm-autotrader-cell-value {
        font-size: 15px;
        font-weight: 800;
        color: #fff;
    }
    .pm-autotrader-log {
        border-top: 1px solid rgba(255,255,255,0.06);
        padding-top: 10px;
        color: var(--text-secondary);
        font-size: 12px;
        line-height: 1.45;
    }
    .pm-autotrader-log-item + .pm-autotrader-log-item {
        margin-top: 6px;
    }
    .pm-agent-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
        margin-bottom: 14px;
    }
    .pm-agent-card {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255,255,255,0.02);
    }
    .pm-agent-top {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
    }
    .pm-agent-name {
        font-size: 14px;
        font-weight: 800;
        color: #fff;
    }
    .pm-agent-badge {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        color: var(--text-secondary);
    }
    .pm-agent-badge.live {
        color: #10B981;
        border-color: rgba(16,185,129,0.35);
        background: rgba(16,185,129,0.10);
    }
    .pm-agent-badge.idle {
        color: #94A3B8;
    }
    .pm-agent-line {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.45;
        margin-bottom: 6px;
    }
    .pm-agent-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    /* ============= BRACKET GRID ============= */
    .pm-brackets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 14px;
        margin-bottom: 20px;
    }
    .pm-bracket-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 18px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .pm-bracket-card:hover {
        border-color: rgba(255,255,255,0.15);
    }
    .pm-bracket-card.leading {
        border-color: rgba(0,120,255,0.3);
        background: rgba(0,120,255,0.04);
    }
    .pm-bracket-card.selected {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 1px var(--accent-blue);
    }
    .bracket-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .bracket-name {
        font-size: 15px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
    }
    .bracket-prob {
        font-size: 22px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
        color: var(--accent-blue);
    }
    .bracket-prices {
        margin-bottom: 12px;
    }
    .yes-no-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    .yes-tag {
        font-size: 12px;
        font-weight: 700;
        color: #10B981;
        background: rgba(16,185,129,0.12);
        padding: 3px 10px;
        border-radius: 6px;
    }
    .no-tag {
        font-size: 12px;
        font-weight: 700;
        color: #EF4444;
        background: rgba(239,68,68,0.12);
        padding: 3px 10px;
        border-radius: 6px;
    }
    .ws-mid-row {
        font-size: 11px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .ws-delta.positive { color: #10B981; }
    .ws-delta.negative { color: #EF4444; }

    /* Mini orderbook depth */
    .mini-depth-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 10px;
    }
    .mini-depth {
        margin-bottom: 2px;
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 8px;
        padding: 6px 8px;
        background: rgba(255,255,255,0.02);
    }
    .mini-depth-title {
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.8px;
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    .mini-depth-title.yes { color: #10B981; }
    .mini-depth-title.no { color: #EF4444; }
    .depth-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    .depth-bar-container {
        display: flex;
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
        background: rgba(255,255,255,0.04);
    }
    .depth-bid-bar {
        background: rgba(16,185,129,0.5);
        transition: width 0.3s;
    }
    .depth-ask-bar {
        background: rgba(239,68,68,0.5);
        transition: width 0.3s;
    }
    .depth-prices {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        margin-top: 6px;
    }
    .depth-bid { color: #10B981; font-weight: 600; }
    .depth-spread {
        color: var(--text-secondary);
        font-size: 10px;
        background: rgba(255,255,255,0.05);
        padding: 1px 6px;
        border-radius: 4px;
    }
    .depth-ask { color: #EF4444; font-weight: 600; }

    .bracket-meta {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--text-secondary);
    }
    .bracket-meta .staleness { opacity: 0.6; }

    /* ============= ORDERBOOK DETAIL ============= */
    .pm-orderbook-detail {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(0,120,255,0.2);
        border-radius: 14px;
        padding: 22px;
        margin-inline: 4px;
        margin-bottom: 20px;
        display: none;
    }
    .pm-orderbook-detail.visible { display: block; }
    .ob-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .ob-title {
        font-size: 14px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
    }
    .ob-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 18px;
    }
    .ob-stats {
        display: flex;
        gap: 24px;
        margin-bottom: 16px;
    }
    .ob-stat {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .ob-stat-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
    }
    .ob-stat-value {
        font-size: 18px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
    }
    .ob-stat-value.bid-color { color: #10B981; }
    .ob-stat-value.ask-color { color: #EF4444; }
    .ob-stat-value.spread-color { color: var(--text-secondary); }

    .ob-legend {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
    .ob-outcomes {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
    }
    .ob-outcome-card {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        padding: 12px;
        background: rgba(255,255,255,0.01);
    }
    .ob-outcome-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
    }
    .ob-outcome-title.yes { color: #10B981; }
    .ob-outcome-title.no { color: #EF4444; }
    .ob-outcome-meta {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 10px;
    }
    .ob-book {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .ob-side-title {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    .ob-side-title.bids { color: #10B981; }
    .ob-side-title.asks { color: #EF4444; }
    .ob-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 8px;
        font-size: 12px;
        font-family: 'Space Mono', 'JetBrains Mono', monospace;
        border-radius: 4px;
        margin-bottom: 2px;
        position: relative;
    }
    .ob-row .ob-bg {
        position: absolute;
        top: 0; bottom: 0; right: 0;
        border-radius: 4px;
        opacity: 0.08;
    }
    .ob-row.bid-row .ob-bg { background: #10B981; left: auto; }
    .ob-row.ask-row .ob-bg { background: #EF4444; left: 0; right: auto; }
    .ob-row span { position: relative; z-index: 1; }
    .ob-price { font-weight: 600; }
    .ob-size { color: var(--text-secondary); }

    /* ============= SHIFTS TABLE ============= */
    .pm-shifts {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 22px;
        margin-bottom: 20px;
    }
    .pm-section-title {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--text-secondary);
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .shifts-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .shifts-table th {
        text-align: left;
        padding: 8px 12px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 10px;
        letter-spacing: 1px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .shifts-table td {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .shift-positive { color: #10B981; }
    .shift-negative { color: #EF4444; }

    /* ============= WS DIAGNOSTICS ============= */
    .pm-diagnostics {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 22px;
    }
    .pm-diag-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .pm-diag-content {
        display: none;
        margin-top: 14px;
    }
    .pm-diag-content.visible { display: block; }
    .diag-grid {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }
    .diag-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .diag-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
    }
    .diag-value {
        font-size: 14px;
        font-weight: 600;
        font-family: 'Space Grotesk', sans-serif;
    }

    /* ============= LOADING / ERROR ============= */
    .pm-loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        font-size: 14px;
    }
    .pm-error {
        text-align: center;
        padding: 40px 20px;
        color: #EF4444;
        font-size: 14px;
    }
    .pm-last-update {
        text-align: right;
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 16px;
        opacity: 0.6;
    }

    /* ============= RESPONSIVE ============= */
    @media (max-width: 900px) {
        .pm-brackets-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
        .mini-depth-grid { grid-template-columns: 1fr; }
        .ob-outcomes { grid-template-columns: 1fr; }
        .ob-book { grid-template-columns: 1fr; }
        .pm-trading-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .pm-autotrader-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .pm-agent-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 600px) {
        .pm-brackets-grid { grid-template-columns: 1fr; }
        .pm-overview { flex-direction: column; align-items: flex-start; }
        .pm-overview-right { align-items: flex-start; }
        .pm-trading-grid { grid-template-columns: 1fr; }
        .pm-autotrader-head { flex-direction: column; }
        .pm-autotrader-actions { justify-content: flex-start; }
        .pm-autotrader-grid { grid-template-columns: 1fr; }
        .pm-agent-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-title">
        <i data-lucide="candlestick-chart" style="width:24px;height:24px;color:var(--accent-blue);"></i>
        Trading
    </div>
    <div class="pm-controls">
        <div class="pm-day-toggle">
            <button class="pm-day-btn active" data-day="0" onclick="selectDay(0)">Today</button>
            <button class="pm-day-btn" data-day="1" onclick="selectDay(1)">Tomorrow</button>
        </div>
        <span id="pm-ws-badge" class="pm-ws-badge disconnected">WS OFF</span>
    </div>
</div>

<div class="page-content">
<!-- Loading state -->
<div id="pm-loading" class="pm-loading">Loading market data...</div>

<!-- Content (hidden until data loads) -->
<div id="pm-content" style="display:none;">

    <!-- Section 1: Market Overview -->
    <div class="pm-overview">
        <div class="pm-overview-left">
            <div class="pm-event-title" id="pm-event-title">--</div>
            <div class="pm-event-meta">
                <span id="pm-date">--</span>
                <span class="pm-volume" id="pm-volume">$--</span>
                <span class="pm-status-badge open" id="pm-status">OPEN</span>
            </div>
        </div>
        <div class="pm-overview-right">
            <div class="pm-sentiment" id="pm-sentiment">--</div>
        </div>
    </div>

    <!-- Section 2: Trading -->
    <div class="pm-trading" id="pm-trading-section" style="display:none;">
        <div class="pm-section-title">
            <i data-lucide="crosshair"></i> Trading
        </div>
        <div class="pm-autotrader" id="pm-autotrader-panel" style="display:none;"></div>
        <div class="pm-agent-grid" id="pm-agent-grid"></div>
        <div class="pm-trading-grid" id="pm-trading-grid"></div>
        <div id="pm-trading-table-wrap"></div>
    </div>

    <!-- Section 3: Bracket Grid -->
    <div class="pm-brackets-grid" id="pm-brackets-grid">
        <!-- Filled by JS -->
    </div>

    <!-- Section 4: Orderbook Detail (hidden until bracket clicked) -->
    <div class="pm-orderbook-detail" id="pm-orderbook-detail">
        <div class="ob-header">
            <div class="ob-title" id="ob-title">--</div>
            <button class="ob-close" onclick="closeBracketDetail()">&times;</button>
        </div>
        <div class="ob-stats" id="ob-stats"></div>
        <div class="ob-legend">Equivalencias Polymarket: <strong>BUY YES = SELL NO</strong> y <strong>BUY NO = SELL YES</strong>.</div>
        <div class="ob-outcomes">
            <div class="ob-outcome-card">
                <div class="ob-outcome-title yes">YES Book</div>
                <div class="ob-outcome-meta">Token YES del bracket seleccionado</div>
                <div class="ob-book">
                    <div>
                        <div class="ob-side-title bids">Bids (Buy YES)</div>
                        <div id="ob-yes-bids"></div>
                    </div>
                    <div>
                        <div class="ob-side-title asks">Asks (Sell YES)</div>
                        <div id="ob-yes-asks"></div>
                    </div>
                </div>
            </div>
            <div class="ob-outcome-card">
                <div class="ob-outcome-title no">NO Book</div>
                <div class="ob-outcome-meta">Token NO del bracket seleccionado</div>
                <div class="ob-book">
                    <div>
                        <div class="ob-side-title bids">Bids (Buy NO)</div>
                        <div id="ob-no-bids"></div>
                    </div>
                    <div>
                        <div class="ob-side-title asks">Asks (Sell NO)</div>
                        <div id="ob-no-asks"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 5: Market Shifts -->
    <div class="pm-shifts" id="pm-shifts-section" style="display:none;">
        <div class="pm-section-title">
            <i data-lucide="trending-up"></i> Market Shifts (last 60 min)
        </div>
        <table class="shifts-table">
            <thead>
                <tr>
                    <th>Bracket</th>
                    <th>Before</th>
                    <th>Now</th>
                    <th>Change</th>
                    <th>Velocity</th>
                </tr>
            </thead>
            <tbody id="pm-shifts-body"></tbody>
        </table>
    </div>

    <!-- Section 6: WS Diagnostics (collapsible) -->
    <div class="pm-diagnostics">
        <div class="pm-diag-toggle" onclick="toggleDiagnostics()">
            <div class="pm-section-title" style="margin-bottom:0;">
                <i data-lucide="radio"></i> WebSocket Diagnostics
            </div>
            <i data-lucide="chevron-down" id="diag-chevron"></i>
        </div>
        <div class="pm-diag-content" id="pm-diag-content">
            <div class="diag-grid" id="pm-diag-grid"></div>
        </div>
    </div>

    <div class="pm-last-update">Last update: <span id="pm-last-update">--:--:--</span></div>
</div>

<!-- Error state -->
<div id="pm-error" class="pm-error" style="display:none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let selectedStation = (window.HeliosStationState && window.HeliosStationState.get())
        ? window.HeliosStationState.get()
        : '{{ active_stations[0] if active_stations else "" }}';
    let selectedDay = 0;
    let selectedBracket = null;
    let lastData = null;
    const REFRESH_MS = 5000;

    function firstNum(...values) {
        for (const value of values) {
            if (typeof value === 'number' && Number.isFinite(value)) return value;
        }
        return null;
    }

    function firstArray(...values) {
        for (const value of values) {
            if (Array.isArray(value)) return value;
        }
        return [];
    }

    function cents(v, decimals = 1) {
        if (typeof v !== 'number' || !Number.isFinite(v)) return '--';
        return `${(v * 100).toFixed(decimals)}c`;
    }

    function pct(v, decimals = 0) {
        if (typeof v !== 'number' || !Number.isFinite(v)) return '--';
        return `${(v * 100).toFixed(decimals)}%`;
    }

    function signedPct(v, decimals = 1) {
        if (typeof v !== 'number' || !Number.isFinite(v)) return '--';
        const sign = v > 0 ? '+' : '';
        return `${sign}${(v * 100).toFixed(decimals)}%`;
    }

    function signedPointsLabel(v, decimals = 1) {
        if (typeof v !== 'number' || !Number.isFinite(v)) return '--';
        const sign = v > 0 ? '+' : '';
        return `${sign}${v.toFixed(decimals)} pts`;
    }

    function signedTempDeltaLabel(v, unit, decimals = 1) {
        if (typeof v !== 'number' || !Number.isFinite(v)) return '--';
        const sign = v > 0 ? '+' : '';
        return `${sign}${v.toFixed(decimals)}&deg;${unit}`;
    }

    function marketTempLabel(v, unit, decimals = 1) {
        if (typeof v !== 'number' || !Number.isFinite(v)) return '--';
        return `${v.toFixed(decimals)}&deg;${unit}`;
    }

    function resolveBook(bracket, side) {
        if (side === 'yes') {
            return {
                bestBid: firstNum(bracket.ws_yes_best_bid, bracket.ws_best_bid),
                bestAsk: firstNum(bracket.ws_yes_best_ask, bracket.ws_best_ask),
                spread: firstNum(bracket.ws_yes_spread, bracket.ws_spread),
                mid: firstNum(bracket.ws_yes_mid, bracket.ws_mid),
                bidDepth: firstNum(bracket.ws_yes_bid_depth, bracket.ws_bid_depth),
                askDepth: firstNum(bracket.ws_yes_ask_depth, bracket.ws_ask_depth),
                bids: firstArray(bracket.ws_yes_bids, bracket.ws_bids),
                asks: firstArray(bracket.ws_yes_asks, bracket.ws_asks),
                stalenessMs: firstNum(bracket.ws_yes_staleness_ms, bracket.ws_staleness_ms),
            };
        }
        return {
            bestBid: firstNum(bracket.ws_no_best_bid),
            bestAsk: firstNum(bracket.ws_no_best_ask),
            spread: firstNum(bracket.ws_no_spread),
            mid: firstNum(bracket.ws_no_mid),
            bidDepth: firstNum(bracket.ws_no_bid_depth),
            askDepth: firstNum(bracket.ws_no_ask_depth),
            bids: firstArray(bracket.ws_no_bids),
            asks: firstArray(bracket.ws_no_asks),
            stalenessMs: firstNum(bracket.ws_no_staleness_ms),
        };
    }

    function renderMiniDepth(side, book) {
        if (book.bestBid === null && book.bestAsk === null) return '';
        const depthBid = firstNum(book.bidDepth, 0) || 0;
        const depthAsk = firstNum(book.askDepth, 0) || 0;
        const totalDepth = depthBid + depthAsk;
        const bidPct = totalDepth > 0 ? ((depthBid / totalDepth) * 100).toFixed(0) : 50;
        const askPct = totalDepth > 0 ? ((depthAsk / totalDepth) * 100).toFixed(0) : 50;
        const sideClass = side.toLowerCase();
        return `
            <div class="mini-depth">
                <div class="mini-depth-title ${sideClass}">${side} Book</div>
                <div class="depth-labels">
                    <span>Bid Depth: $${depthBid.toLocaleString()}</span>
                    <span>Ask Depth: $${depthAsk.toLocaleString()}</span>
                </div>
                <div class="depth-bar-container">
                    <div class="depth-bid-bar" style="width:${bidPct}%"></div>
                    <div class="depth-ask-bar" style="width:${askPct}%"></div>
                </div>
                <div class="depth-prices">
                    <span class="depth-bid">${cents(book.bestBid)}</span>
                    <span class="depth-spread">spread ${cents(book.spread)}</span>
                    <span class="depth-ask">${cents(book.bestAsk)}</span>
                </div>
            </div>
        `;
    }

    function renderBookRows(targetId, levels, rowClass, emptyLabel) {
        const el = document.getElementById(targetId);
        el.innerHTML = '';
        if (!levels || levels.length === 0) {
            el.innerHTML = `<div style="color:var(--text-secondary);font-size:12px;padding:8px;">${emptyLabel}</div>`;
            return;
        }
        const maxSize = Math.max(...levels.map(x => x.size || 0), 0);
        levels.forEach(level => {
            const pct = maxSize > 0 ? ((level.size || 0) / maxSize * 100).toFixed(0) : 0;
            el.innerHTML += `
                <div class="ob-row ${rowClass}">
                    <div class="ob-bg" style="width:${pct}%"></div>
                    <span class="ob-price">${cents(level.price)}</span>
                    <span class="ob-size">${(level.size || 0).toLocaleString()}</span>
                </div>`;
        });
    }

    // ========================
    // DATA FETCHING
    // ========================
    async function fetchData() {
        try {
            const resp = await fetch(`/api/polymarket/${selectedStation}?target_day=${selectedDay}&depth=5`, { cache: 'no-store' });
            const data = await resp.json();
            if (data.error) {
                showError(data.error);
                return;
            }
            lastData = data;
            document.getElementById('pm-loading').style.display = 'none';
            document.getElementById('pm-error').style.display = 'none';
            document.getElementById('pm-content').style.display = 'block';
            renderAll(data);
        } catch (e) {
            showError('Failed to fetch market data');
        }
    }

    function showError(msg) {
        document.getElementById('pm-loading').style.display = 'none';
        document.getElementById('pm-content').style.display = 'none';
        const el = document.getElementById('pm-error');
        el.style.display = 'block';
        el.textContent = msg;
    }

    // ========================
    // RENDER ALL
    // ========================
    function renderAll(data) {
        renderOverview(data);
        renderAutoTrader(data.autotrader, data.trading);
        renderAutotraderAgents(data.autotrader_agents);
        renderTrading(data.trading);
        renderBrackets(data.brackets);
        renderShifts(data.shifts);
        renderDiagnostics(data);
        if (selectedBracket) {
            const b = data.brackets.find(x => x.name === selectedBracket);
            if (b) renderOrderbookDetail(b);
            else closeBracketDetail();
        }
        document.getElementById('pm-last-update').textContent = new Date().toLocaleTimeString();
    }

    function shortTs(value) {
        if (!value) return '--';
        const raw = String(value);
        return raw.length >= 16 ? raw.slice(11, 16) : raw;
    }

    async function runAutotraderAction(action) {
        try {
            const resp = await fetch(`/api/autotrader/${action}?station_id=${encodeURIComponent(selectedStation)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            const data = await resp.json();
            if (data.error || data.ok === false) throw new Error(data.error || 'request failed');
            await fetchData();
        } catch (e) {
            showError(`Autotrader ${action} failed: ${e.message || e}`);
        }
    }
    window.runAutotraderAction = runAutotraderAction;

    async function runAutotraderAgentAction(action, stationId) {
        try {
            const resp = await fetch(`/api/autotrader/${action}?station_id=${encodeURIComponent(stationId)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            const data = await resp.json();
            if (data.error || data.ok === false) throw new Error(data.error || 'request failed');
            await fetchData();
        } catch (e) {
            showError(`Autotrader ${action} failed: ${e.message || e}`);
        }
    }
    window.runAutotraderAgentAction = runAutotraderAgentAction;

    function renderAutoTrader(status, trading) {
        const panel = document.getElementById('pm-autotrader-panel');
        if (!panel) return;
        if (!status) {
            panel.style.display = 'none';
            return;
        }

        panel.style.display = 'block';
        const state = status.state || {};
        const portfolio = status.portfolio || {};
        const risk = status.risk || {};
        const strategy = status.strategy || {};
        const wallet = status.wallet || {};
        const recent = Array.isArray(status.recent_events) ? status.recent_events.slice(0, 3) : [];
        const openBets = Array.isArray(portfolio.open_positions) ? portfolio.open_positions.slice(0, 4) : [];
        const best = trading?.best_terminal_trade || null;
        const fast = trading?.best_tactical_trade || null;
        const bestIdea = best ? `${best.best_side} ${best.label}` : 'No live idea';
        const fastIdea = fast ? `${fast.tactical_best_side || fast.best_side} ${fast.label}` : 'No tactical idea';
        const headline = status.running
            ? `Running ${String(status.mode || 'paper').toUpperCase()} with ${String(status.order_mode || 'limit_fak').toUpperCase()}`
            : `${String(status.mode || 'paper').toUpperCase()} configured, loop stopped`;
        const subline = `Terminal: ${bestIdea}. Tactical: ${fastIdea}. WS book ${status.prefer_ws_book ? 'preferred' : 'disabled'} · wallet ${wallet.live_ready ? 'ready' : 'missing keys'}.`;
        const stations = Array.isArray(status.stations) && status.stations.length ? status.stations.join(', ') : 'None';
        const strategyMix = [];
        if (strategy.terminal_enabled) strategyMix.push(`terminal ${Number(strategy.terminal_take_profit_pts || 0).toFixed(1)}/${Number(strategy.terminal_stop_loss_pts || 0).toFixed(1)} pts`);
        if (strategy.tactical_enabled) strategyMix.push(`tactical ${Number(strategy.tactical_take_profit_pts || 0).toFixed(1)}/${Number(strategy.tactical_stop_loss_pts || 0).toFixed(1)} pts`);
        const pnlToday = Number(portfolio.realized_pnl_today_usd || 0);
        const strategyCounts = state.strategies || {};
        const strategyCountText = Object.keys(strategyCounts).length
            ? Object.entries(strategyCounts).map(([key, value]) => `${key.replace('_', ' ')} ${value}`).join(' Â· ')
            : 'none';

        panel.innerHTML = `
            <div class="pm-autotrader-head">
                <div>
                    <div class="pm-autotrader-title">Autotrader</div>
                    <div class="pm-autotrader-main">${headline}</div>
                    <div class="pm-autotrader-sub">${subline}</div>
                </div>
                <div class="pm-autotrader-actions">
                    <button class="pm-autotrader-btn primary" onclick="runAutotraderAction('run-once')" ${status.running ? 'disabled' : ''}>Run once</button>
                    <button class="pm-autotrader-btn" onclick="runAutotraderAction('start')" ${status.running ? 'disabled' : ''}>Start loop</button>
                    <button class="pm-autotrader-btn danger" onclick="runAutotraderAction('stop')" ${status.running ? '' : 'disabled'}>Stop loop</button>
                </div>
            </div>
            <div class="pm-autotrader-grid">
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Stations</div>
                    <div class="pm-autotrader-cell-value">${stations}</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Portfolio Exposure</div>
                    <div class="pm-autotrader-cell-value">$${Number(portfolio.open_risk_usd || 0).toFixed(2)} / $${Number(risk.max_total_exposure_usd || 0).toFixed(2)}</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">This Agent</div>
                    <div class="pm-autotrader-cell-value">${Number(state.open_positions || 0)} live bets · $${Number(state.open_risk_usd || 0).toFixed(2)}</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Portfolio Day</div>
                    <div class="pm-autotrader-cell-value">${Number(portfolio.trades_today || 0)} entries · $${Number(portfolio.remaining_daily_loss_usd || 0).toFixed(2)} loss room</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Day PnL</div>
                    <div class="pm-autotrader-cell-value">${pnlToday >= 0 ? '+' : ''}$${pnlToday.toFixed(2)} · ${Number(portfolio.closed_trades_today || 0)} exits</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Strategy</div>
                    <div class="pm-autotrader-cell-value">${strategyMix.join(' · ') || 'disabled'}</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Agent Mix</div>
                    <div class="pm-autotrader-cell-value">${strategyCountText}</div>
                </div>
                <div class="pm-autotrader-cell">
                    <div class="pm-autotrader-cell-label">Loop</div>
                    <div class="pm-autotrader-cell-value">${Number(status.loop_seconds || 0)}s · ${status.kill_switch_active ? 'STOP FILE ON' : 'clear'}</div>
                </div>
            </div>
            <div class="pm-autotrader-log">
                <div class="pm-autotrader-title" style="margin-bottom:8px;">Recent activity</div>
                ${recent.length ? recent.map(item => `
                    <div class="pm-autotrader-log-item">
                        <strong>${item.status || 'event'}</strong>
                        ${item.station_id ? ` · ${item.station_id}` : ''}
                        ${item.candidate ? ` · ${item.candidate.strategy || 'terminal_value'} · ${item.candidate.side} ${item.candidate.label}` : ''}
                        ${item.exit_plan ? ` · exit ${item.exit_plan.reason || '--'}` : ''}
                        ${item.reasons && item.reasons.length ? ` · ${item.reasons.join(', ')}` : ''}
                        ${item.plan ? ` · $${Number(item.plan.notional_usd || 0).toFixed(2)}` : ''}
                        ${item.persisted ? ` · pnl $${Number(item.persisted.realized_pnl_usd || 0).toFixed(2)}` : ''}
                        <span style="opacity:.7;"> · ${shortTs(item.ts_utc)}</span>
                    </div>
                `).join('') : '<div class="pm-autotrader-log-item">No runs yet.</div>'}
                <div class="pm-autotrader-title" style="margin:12px 0 8px;">Open bets</div>
                ${openBets.length ? openBets.map(item => `
                    <div class="pm-autotrader-log-item">
                        <strong>${item.station_id} · ${item.strategy || 'terminal_value'} · ${item.side} ${item.label}</strong>
                        · $${Number(item.cost_basis_open_usd || item.notional_usd || 0).toFixed(2)}
                        · ${Number(item.shares_open || item.shares || 0).toFixed(1)} sh
                        <span style="opacity:.7;"> · ${shortTs(item.opened_at_utc)}</span>
                    </div>
                `).join('') : '<div class="pm-autotrader-log-item">No open bets in the portfolio.</div>'}
            </div>
        `;
    }

    function renderAutotraderAgents(statusPayload) {
        const grid = document.getElementById('pm-agent-grid');
        if (!grid) return;
        const agents = Array.isArray(statusPayload?.agents) ? statusPayload.agents : [];
        if (!agents.length) {
            grid.innerHTML = '';
            return;
        }
        grid.innerHTML = agents.map(agent => {
            const stationId = agent.station_id || '--';
            const running = Boolean(agent.running);
            const liveMode = String(agent.mode || 'paper').toUpperCase();
            const risk = agent.risk || {};
            const state = agent.state || {};
            const strategy = agent.strategy || {};
            const portfolio = agent.portfolio || {};
            const recent = Array.isArray(agent.recent_events) ? agent.recent_events[0] : null;
            const strategies = state.strategies || {};
            const strategyLine = Object.keys(strategies).length
                ? Object.entries(strategies).map(([key, value]) => `${key.replace('_', ' ')} ${value}`).join(' · ')
                : 'no open bets';
            return `
                <div class="pm-agent-card">
                    <div class="pm-agent-top">
                        <div class="pm-agent-name">${stationId}</div>
                        <div class="pm-agent-badge ${running ? 'live' : 'idle'}">${running ? 'RUNNING' : 'IDLE'}</div>
                    </div>
                    <div class="pm-agent-line">${liveMode} · ${String(agent.order_mode || 'limit_fak').toUpperCase()}</div>
                    <div class="pm-agent-line">Own risk $${Number(state.open_risk_usd || 0).toFixed(2)} · portfolio $${Number(portfolio.open_risk_usd || 0).toFixed(2)} / $${Number(risk.max_total_exposure_usd || 0).toFixed(2)}</div>
                    <div class="pm-agent-line">Own bets ${Number(state.open_positions || 0)} · portfolio ${Number(portfolio.open_positions_count || 0)} · day pnl ${Number(portfolio.realized_pnl_today_usd || 0) >= 0 ? '+' : ''}$${Number(portfolio.realized_pnl_today_usd || 0).toFixed(2)}</div>
                    <div class="pm-agent-line">${strategyLine} · tactical ${strategy.tactical_enabled ? 'on' : 'off'}</div>
                    <div class="pm-agent-line">Last ${recent ? shortTs(recent.ts_utc) : '--'}</div>
                    <div class="pm-agent-actions">
                        <button class="pm-autotrader-btn primary" onclick="selectStation('${stationId}')">Open</button>
                        <button class="pm-autotrader-btn" onclick="runAutotraderAgentAction('start','${stationId}')" ${running ? 'disabled' : ''}>Start</button>
                        <button class="pm-autotrader-btn danger" onclick="runAutotraderAgentAction('stop','${stationId}')" ${running ? '' : 'disabled'}>Stop</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ========================
    // OVERVIEW
    // ========================
    function renderOverview(data) {
        document.getElementById('pm-event-title').textContent = data.event_title;
        const d = new Date(data.target_date + 'T00:00:00');
        document.getElementById('pm-date').textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        document.getElementById('pm-volume').textContent = `$${(data.total_volume / 1000).toFixed(0)}K Vol.`;

        // Status badge
        const statusEl = document.getElementById('pm-status');
        const st = data.market_status;
        if (st.event_closed || !st.event_active) {
            statusEl.textContent = 'CLOSED';
            statusEl.className = 'pm-status-badge closed';
        } else if (st.is_mature) {
            statusEl.textContent = 'MATURE';
            statusEl.className = 'pm-status-badge mature';
        } else {
            statusEl.textContent = 'OPEN';
            statusEl.className = 'pm-status-badge open';
        }

        // WS badge
        const wsBadge = document.getElementById('pm-ws-badge');
        if (data.ws_connected) {
            wsBadge.textContent = 'WS LIVE';
            wsBadge.className = 'pm-ws-badge connected';
        } else {
            wsBadge.textContent = 'WS OFF';
            wsBadge.className = 'pm-ws-badge disconnected';
        }

        // Sentiment
        const sentEl = document.getElementById('pm-sentiment');
        sentEl.textContent = data.sentiment;
        if (data.sentiment.startsWith('AGGRESSIVE')) sentEl.className = 'pm-sentiment aggressive';
        else if (data.sentiment.startsWith('SHIFTING')) sentEl.className = 'pm-sentiment shifting';
        else sentEl.className = 'pm-sentiment';
    }

    function renderTrading(trading) {
        const section = document.getElementById('pm-trading-section');
        const grid = document.getElementById('pm-trading-grid');
        const tableWrap = document.getElementById('pm-trading-table-wrap');
        if (!trading || trading.available === false) {
            section.style.display = 'block';
            grid.innerHTML = '';
            tableWrap.innerHTML = `
                <div style="margin-top:14px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text-secondary); font-size:12px; line-height:1.5;">
                    Trading signal unavailable for this market right now.
                </div>
            `;
            return;
        }

        section.style.display = 'block';
        const model = trading.model || {};
        const terminal = trading.best_terminal_trade || null;
        const tacticalContext = trading.tactical_context || {};
        const nextMetar = tacticalContext.next_metar || null;
        const tactical = trading.best_tactical_trade || null;
        const policy = trading.policy || {};
        const forecast = trading.forecast_winner || null;
        const unit = trading.market_unit || 'F';
        const topBucket = model.top_label || model.expected_label || '--';
        const topBucketProb = Number(model.top_label_probability);
        const forecastMarket = forecast ? forecast.market_probability : null;
        const forecastFair = forecast ? forecast.model_probability : topBucketProb;
        const forecastEdgePts = forecast ? forecast.edge_points : null;
        const terminalMarket = terminal ? (terminal.selected_entry ?? (terminal.best_side === 'YES' ? terminal.yes_entry : terminal.no_entry)) : null;
        const terminalFair = terminal ? (terminal.selected_fair ?? (terminal.best_side === 'YES' ? terminal.fair_yes : terminal.fair_no)) : null;
        const terminalEdgePts = terminal ? (terminal.edge_points ?? (Number(terminal.best_edge) * 100.0)) : null;
        const tacticalSide = tactical ? (tactical.tactical_best_side || tactical.best_side) : null;
        const tacticalMarket = tactical ? (tactical.selected_tactical_entry ?? (tacticalSide === 'YES' ? tactical.yes_entry : tactical.no_entry)) : null;
        const tacticalFair = tactical ? (tactical.selected_tactical_fair ?? (tacticalSide === 'YES' ? tactical.tactical_yes : tactical.tactical_no)) : null;
        const tacticalEdgePts = tactical ? (tactical.tactical_edge_points ?? (Number(tactical.tactical_best_edge) * 100.0)) : null;

        const terminalClass = terminal && terminal.best_edge > 0.04 ? 'good' : 'watch';
        const tacticalClass = tactical && tactical.tactical_best_edge > 0.03 ? 'good' : 'watch';
        const rows = (Array.isArray(trading.terminal_opportunities) ? trading.terminal_opportunities : []).slice(0, 3);
        const showFastTrade = tactical
            && (
                tacticalSide !== terminal?.best_side
                || tactical.label !== terminal?.label
                || Math.abs(Number(tacticalEdgePts || 0) - Number(terminalEdgePts || 0)) >= 5.0
            );
        const bestTradeLabel = terminal ? `${terminal.best_side} ${terminal.label}` : 'No clear trade';
        const fastTradeLabel = tactical ? `${tacticalSide} ${tactical.label}` : 'No fast trade';
        const nextMetarSummary = nextMetar
            ? `${nextMetar.direction === 'FLAT' ? 'flat' : nextMetar.direction.toLowerCase()} ${signedTempDeltaLabel(nextMetar.delta_market, unit, 1)}`
            : '--';
        const forecastVsValue = terminal && topBucket !== '--' && terminal.best_side === 'YES' && terminal.label !== topBucket
            ? `${topBucket} is still the forecast winner, but it is priced at ${pct(forecastMarket)} versus ${pct(forecastFair)} model. ${terminal.label} is less likely, but cheaper at ${pct(terminalMarket)} versus ${pct(terminalFair)} model.`
            : '';
        const rationale = terminal
            ? (terminal.policy_reason || 'This idea passes the live trading policy.')
            : (policy.headline || 'No trade passes the live policy right now.');
        const blockedCount = Number(policy.blocked_terminal_count || 0);
        const filteredNote = blockedCount > 0
            ? `${blockedCount} other ideas were filtered out because the edge was too small or the move no longer made physical sense.`
            : '';

        grid.innerHTML = `
            <div class="pm-trade-card">
                <div class="pm-trade-label">Forecast Winner</div>
                <div class="pm-trade-main">${topBucket}</div>
                <div class="pm-trade-sub">
                    Model ${pct(forecastFair)}<br>
                    Market ${pct(forecastMarket)} ${forecastEdgePts !== null ? `(${signedPointsLabel(forecastEdgePts)})` : ''}
                </div>
            </div>
            <div class="pm-trade-card ${terminalClass}">
                <div class="pm-trade-label">Best Value Bet</div>
                <div class="pm-trade-main">${bestTradeLabel}</div>
                <div class="pm-trade-sub">
                    Market ${terminal ? pct(terminalMarket) : '--'}<br>
                    Model ${terminal ? pct(terminalFair) : '--'} ${terminal ? `(${signedPointsLabel(terminalEdgePts)})` : ''}
                </div>
            </div>
            <div class="pm-trade-card ${nextMetar && nextMetar.direction !== 'FLAT' ? 'good' : ''}">
                <div class="pm-trade-label">Next Official Estimate</div>
                <div class="pm-trade-main">${nextMetar && typeof nextMetar.expected_market === 'number' ? marketTempLabel(nextMetar.expected_market, unit, 1) : '--'}</div>
                <div class="pm-trade-sub">
                    ${nextMetar ? `${nextMetar.minutes_to_next?.toFixed ? nextMetar.minutes_to_next.toFixed(0) : '--'} min` : '--'}<br>
                    ${nextMetarSummary}
                </div>
            </div>
            ${showFastTrade ? `
                <div class="pm-trade-card ${tacticalClass}">
                    <div class="pm-trade-label">If Next Official Prints</div>
                    <div class="pm-trade-main">${fastTradeLabel}</div>
                    <div class="pm-trade-sub">
                        Market ${tactical ? pct(tacticalMarket) : '--'}<br>
                        Model ${tactical ? pct(tacticalFair) : '--'}
                    </div>
                </div>
            ` : ''}
        `;

        if (!rows.length) {
            tableWrap.innerHTML = `
                <div style="margin-top:14px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text-secondary); font-size:12px; line-height:1.5;">
                    <div class="pm-trade-label" style="margin-bottom:8px;">Why</div>
                    ${rationale}
                    ${forecastVsValue ? `<div style="margin-top:8px;">${forecastVsValue}</div>` : ''}
                    ${filteredNote ? `<div style="margin-top:8px;">${filteredNote}</div>` : ''}
                </div>
            `;
            return;
        }

        tableWrap.innerHTML = `
            <table class="pm-trading-table">
                <thead>
                    <tr>
                        <th>Idea</th>
                        <th>Why</th>
                        <th>Market</th>
                        <th>Model</th>
                        <th>Edge</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(row => {
                        const fair = row.selected_fair ?? (row.best_side === 'YES' ? row.fair_yes : row.fair_no);
                        const entry = row.selected_entry ?? (row.best_side === 'YES' ? row.yes_entry : row.no_entry);
                        const edgePts = row.edge_points ?? (Number(row.best_edge || 0) * 100.0);
                        const edgeClass = row.best_edge > 0 ? 'pm-edge-positive' : 'pm-edge-neutral';
                        return `
                            <tr>
                                <td style="font-weight:700;">${row.best_side} ${row.label}</td>
                                <td>${row.policy_reason || '--'}</td>
                                <td>${pct(entry)}</td>
                                <td>${pct(fair)}</td>
                                <td class="${edgeClass}">${signedPointsLabel(edgePts)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        tableWrap.innerHTML += `
            <div style="margin-top:14px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text-secondary); font-size:12px; line-height:1.5;">
                <div class="pm-trade-label" style="margin-bottom:8px;">Why</div>
                ${rationale}
                ${forecastVsValue ? `<div style="margin-top:8px;">${forecastVsValue}</div>` : ''}
                ${filteredNote ? `<div style="margin-top:8px;">${filteredNote}</div>` : ''}
            </div>
        `;
    }

    // ========================
    // BRACKETS
    // ========================
    function renderBrackets(brackets) {
        const grid = document.getElementById('pm-brackets-grid');
        grid.innerHTML = '';

        brackets.forEach((b, idx) => {
            const card = document.createElement('div');
            const isLeading = idx === 0;
            const isSelected = b.name === selectedBracket;
            card.className = `pm-bracket-card${isLeading ? ' leading' : ''}${isSelected ? ' selected' : ''}`;
            card.onclick = () => toggleBracketDetail(b.name);

            const yesBook = resolveBook(b, 'yes');
            const noBook = resolveBook(b, 'no');
            const yesP = (b.yes_price * 100).toFixed(1);
            const noP = (b.no_price * 100).toFixed(1);

            // WS mid delta
            let wsMidHtml = `<div class="ws-mid-row">Model: YES ${yesP}c | NO ${noP}c</div>`;
            if (yesBook.mid !== null) {
                const wsMid = (yesBook.mid * 100).toFixed(1);
                const delta = ((yesBook.mid - b.yes_price) * 100).toFixed(1);
                const cls = delta > 0 ? 'positive' : delta < 0 ? 'negative' : '';
                wsMidHtml += `<div class="ws-mid-row">WS YES Mid: ${wsMid}c <span class="ws-delta ${cls}">(${delta > 0 ? '+' : ''}${delta} vs model)</span></div>`;
            }
            if (noBook.mid !== null) {
                wsMidHtml += `<div class="ws-mid-row">WS NO Mid: ${(noBook.mid * 100).toFixed(1)}c</div>`;
            }

            // Mini depth bars (YES + NO)
            let depthHtml = '';
            const yesDepth = renderMiniDepth('YES', yesBook);
            const noDepth = renderMiniDepth('NO', noBook);
            if (yesDepth || noDepth) {
                depthHtml = `<div class="mini-depth-grid">${yesDepth}${noDepth}</div>`;
            }

            // Staleness
            let stalenessHtml = '';
            const stalenessLabels = [];
            if (yesBook.stalenessMs !== null) stalenessLabels.push(`YES ${yesBook.stalenessMs}ms`);
            if (noBook.stalenessMs !== null) stalenessLabels.push(`NO ${noBook.stalenessMs}ms`);
            if (stalenessLabels.length > 0) {
                stalenessHtml = `<span class="staleness">${stalenessLabels.join(' | ')}</span>`;
            }

            card.innerHTML = `
                <div class="bracket-header">
                    <span class="bracket-name">${b.name}</span>
                    <span class="bracket-prob">${yesP}%</span>
                </div>
                <div class="bracket-prices">
                    <div class="yes-no-row">
                        <span class="yes-tag">YES ${yesP}c</span>
                        <span class="no-tag">NO ${noP}c</span>
                    </div>
                    ${wsMidHtml}
                </div>
                ${depthHtml}
                <div class="bracket-meta">
                    <span>$${b.volume.toLocaleString()} Vol.</span>
                    ${stalenessHtml}
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // ========================
    // ORDERBOOK DETAIL
    // ========================
    function toggleBracketDetail(name) {
        if (selectedBracket === name) {
            closeBracketDetail();
        } else {
            selectedBracket = name;
            if (lastData) {
                const b = lastData.brackets.find(x => x.name === name);
                if (b) renderOrderbookDetail(b);
            }
            // Re-render brackets to show selection
            if (lastData) renderBrackets(lastData.brackets);
        }
    }

    function closeBracketDetail() {
        selectedBracket = null;
        document.getElementById('pm-orderbook-detail').classList.remove('visible');
        if (lastData) renderBrackets(lastData.brackets);
    }
    window.closeBracketDetail = closeBracketDetail;

    function renderOrderbookDetail(b) {
        const panel = document.getElementById('pm-orderbook-detail');
        panel.classList.add('visible');

        document.getElementById('ob-title').textContent = `Orderbook: ${b.name}`;
        const yesBook = resolveBook(b, 'yes');
        const noBook = resolveBook(b, 'no');

        // Stats
        const statsEl = document.getElementById('ob-stats');
        if (yesBook.bestBid !== null || noBook.bestBid !== null) {
            statsEl.innerHTML = `
                <div class="ob-stat">
                    <span class="ob-stat-label">YES Bid/Ask</span>
                    <span class="ob-stat-value bid-color">${cents(yesBook.bestBid, 2)} / ${cents(yesBook.bestAsk, 2)}</span>
                </div>
                <div class="ob-stat">
                    <span class="ob-stat-label">YES Spread/Mid</span>
                    <span class="ob-stat-value spread-color">${cents(yesBook.spread, 2)} / ${cents(yesBook.mid, 2)}</span>
                </div>
                <div class="ob-stat">
                    <span class="ob-stat-label">NO Bid/Ask</span>
                    <span class="ob-stat-value ask-color">${cents(noBook.bestBid, 2)} / ${cents(noBook.bestAsk, 2)}</span>
                </div>
                <div class="ob-stat">
                    <span class="ob-stat-label">NO Spread/Mid</span>
                    <span class="ob-stat-value">${cents(noBook.spread, 2)} / ${cents(noBook.mid, 2)}</span>
                </div>
            `;
        } else {
            statsEl.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;">No WebSocket data available</div>';
        }

        renderBookRows('ob-yes-bids', yesBook.bids, 'bid-row', 'No YES bids');
        renderBookRows('ob-yes-asks', yesBook.asks, 'ask-row', 'No YES asks');
        renderBookRows('ob-no-bids', noBook.bids, 'bid-row', 'No NO bids');
        renderBookRows('ob-no-asks', noBook.asks, 'ask-row', 'No NO asks');
    }

    // ========================
    // SHIFTS
    // ========================
    function renderShifts(shifts) {
        const section = document.getElementById('pm-shifts-section');
        const tbody = document.getElementById('pm-shifts-body');
        if (!shifts || shifts.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = 'block';
        tbody.innerHTML = '';
        shifts.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
        shifts.forEach(s => {
            const cls = s.change > 0 ? 'shift-positive' : 'shift-negative';
            const sign = s.change > 0 ? '+' : '';
            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:600;">${s.bracket}</td>
                    <td>${(s.old_prob * 100).toFixed(1)}%</td>
                    <td>${(s.new_prob * 100).toFixed(1)}%</td>
                    <td class="${cls}">${sign}${(s.change * 100).toFixed(1)}%</td>
                    <td class="${cls}">${sign}${(s.velocity * 100).toFixed(1)}%/hr</td>
                </tr>`;
        });
    }

    // ========================
    // DIAGNOSTICS
    // ========================
    function renderDiagnostics(data) {
        const grid = document.getElementById('pm-diag-grid');
        const m = data.ws_metrics || {};
        const yesTracked = data.brackets.filter(b => firstNum(b.ws_yes_best_bid, b.ws_best_bid) !== null).length;
        const noTracked = data.brackets.filter(b => firstNum(b.ws_no_best_bid) !== null).length;
        grid.innerHTML = `
            <div class="diag-item">
                <span class="diag-label">Status</span>
                <span class="diag-value" style="color:${data.ws_connected ? '#10B981' : '#EF4444'}">${data.ws_connected ? 'Connected' : 'Disconnected'}</span>
            </div>
            <div class="diag-item">
                <span class="diag-label">Reconnects</span>
                <span class="diag-value">${m.reconnect_count || 0}</span>
            </div>
            <div class="diag-item">
                <span class="diag-label">Resyncs</span>
                <span class="diag-value">${m.resync_count || 0}</span>
            </div>
            <div class="diag-item">
                <span class="diag-label">Publisher Lag</span>
                <span class="diag-value">${m.publisher_lag_ms || 0}ms</span>
            </div>
            <div class="diag-item">
                <span class="diag-label">Brackets Tracked</span>
                <span class="diag-value">YES ${yesTracked}/${data.brackets.length} | NO ${noTracked}/${data.brackets.length}</span>
            </div>
        `;
    }

    let diagOpen = false;
    function toggleDiagnostics() {
        diagOpen = !diagOpen;
        document.getElementById('pm-diag-content').classList.toggle('visible', diagOpen);
        const chevron = document.getElementById('diag-chevron');
        if (chevron) chevron.style.transform = diagOpen ? 'rotate(180deg)' : '';
    }
    window.toggleDiagnostics = toggleDiagnostics;

    // ========================
    // CONTROLS
    // ========================
    function selectStation(stationId) {
        const normalized = window.HeliosStationState?.normalize?.(stationId) || String(stationId || '').toUpperCase();
        selectedStation = normalized;
        window.HeliosStationState?.set?.(selectedStation, { source: 'trading' });
        const sel = document.getElementById('pm-station-select');
        if (sel && sel.value !== selectedStation) sel.value = selectedStation;
        selectedBracket = null;
        document.getElementById('pm-orderbook-detail').classList.remove('visible');
        fetchData();
    }
    window.selectStation = selectStation;

    function selectDay(day) {
        selectedDay = day;
        document.querySelectorAll('.pm-day-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.day) === day);
        });
        selectedBracket = null;
        document.getElementById('pm-orderbook-detail').classList.remove('visible');
        fetchData();
    }
    window.selectDay = selectDay;

    // ========================
    // INIT
    // ========================
    document.addEventListener('DOMContentLoaded', () => {
        window.addEventListener('helios:stationchange', (event) => {
            const nextStation = event?.detail?.stationId;
            if (!nextStation || nextStation === selectedStation) return;
            selectStation(nextStation);
        });
        fetchData();
        setInterval(fetchData, REFRESH_MS);
        lucide.createIcons();
    });

    // Tab visibility handler
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) fetchData();
    });
})();
</script>
{% endblock %}
