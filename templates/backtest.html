{% extends "base.html" %}

{% block title %}HELIOS - Backtest{% endblock %}

{% block head_extra %}
<style>
    .backtest-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    /* Config Panel */
    .config-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        background: var(--bg-secondary);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .config-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .config-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
    }

    .config-input {
        background: #1a1f2e;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 10px 14px;
        color: var(--text-main);
        font-size: 14px;
        font-family: 'JetBrains Mono', monospace;
    }

    select.config-input {
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 32px;
        cursor: pointer;
    }

    .config-input option {
        background: #1a1f2e;
        color: #e2e8f0;
        padding: 8px;
    }

    .config-input:focus {
        outline: none;
        border-color: var(--accent-blue);
    }

    .run-btn {
        padding: 12px 24px;
        background: var(--accent-blue);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        align-self: flex-end;
    }

    .run-btn:hover {
        opacity: 0.9;
    }

    .run-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Results Panel */
    .results-panel {
        background: var(--bg-secondary);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .results-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .results-title {
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .results-title i {
        width: 20px;
        height: 20px;
        color: var(--accent-blue);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
    }

    .stat-card .label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 5px;
    }

    .stat-card .value {
        font-size: 24px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-card .value.green { color: #10B981; }
    .stat-card .value.red { color: #EF4444; }
    .stat-card .value.blue { color: var(--accent-blue); }

    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .metric-section {
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
        padding: 15px;
    }

    .metric-section h3 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-secondary);
    }

    .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .metric-row:last-child {
        border-bottom: none;
    }

    .metric-name {
        color: var(--text-muted);
        font-size: 13px;
    }

    .metric-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 600;
    }

    /* Day Results Table */
    .day-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 20px;
    }

    .day-table th,
    .day-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .day-table th {
        color: var(--text-muted);
        font-weight: 500;
        text-transform: uppercase;
        font-size: 11px;
    }

    .day-table tr.day-row {
        cursor: pointer;
        transition: background 0.15s;
    }

    .day-table tr.day-row:hover {
        background: rgba(255,255,255,0.04);
    }

    .day-table tr.correct {
        background: rgba(16, 185, 129, 0.1);
    }

    .day-table tr.correct:hover {
        background: rgba(16, 185, 129, 0.18);
    }

    .day-table tr.wrong {
        background: rgba(239, 68, 68, 0.1);
    }

    .day-table tr.wrong:hover {
        background: rgba(239, 68, 68, 0.18);
    }

    .day-table tr.day-row.expanded {
        border-bottom: none;
    }

    /* Coverage badge in day table */
    .coverage-bar-mini {
        display: inline-block;
        width: 40px;
        height: 6px;
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
        overflow: hidden;
        vertical-align: middle;
        margin-right: 4px;
    }

    .coverage-bar-mini-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s;
    }

    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.ok { background: rgba(16,185,129,0.2); color: #10B981; }
    .status-badge.integrity_warning { background: rgba(244,208,63,0.2); color: #F4D03F; }
    .status-badge.no_market_data { background: rgba(239,68,68,0.2); color: #EF4444; }
    .status-badge.no_data { background: rgba(100,116,139,0.2); color: #64748b; }

    .expand-icon {
        display: inline-block;
        transition: transform 0.2s;
        color: var(--text-muted);
        font-size: 12px;
        margin-right: 6px;
    }

    .day-row.expanded .expand-icon {
        transform: rotate(90deg);
    }

    /* Day Detail Drilldown Panel */
    .day-detail-row td {
        padding: 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .day-detail-panel {
        background: var(--bg-primary);
        border: 1px solid rgba(0,120,255,0.15);
        border-radius: 8px;
        margin: 8px 12px 12px;
        overflow: hidden;
    }

    .day-detail-loading {
        padding: 30px;
        text-align: center;
        color: var(--text-muted);
    }

    .day-detail-content {
        padding: 16px;
    }

    /* Coverage Stats Card */
    .dd-stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 16px;
    }

    .dd-stat {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 10px 12px;
        text-align: center;
    }

    .dd-stat .dd-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 4px;
    }

    .dd-stat .dd-value {
        font-size: 16px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-main);
    }

    /* Intraday Chart */
    .dd-chart-container {
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        position: relative;
        height: 280px;
    }

    .dd-chart-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    /* Reason Counters */
    .dd-reasons {
        margin-bottom: 16px;
    }

    .dd-reasons-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .dd-reasons-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .dd-reason-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .dd-reason-chip .count {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        color: var(--text-main);
    }

    /* Fills Blotter */
    .dd-fills-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .dd-fills-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-bottom: 16px;
    }

    .dd-fills-table th,
    .dd-fills-table td {
        padding: 6px 10px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .dd-fills-table th {
        color: var(--text-muted);
        font-weight: 500;
        text-transform: uppercase;
        font-size: 10px;
    }

    .dd-fills-table td {
        font-family: 'JetBrains Mono', monospace;
    }

    .dd-fills-table .buy { color: #10B981; }
    .dd-fills-table .sell { color: #EF4444; }

    .dd-empty {
        padding: 16px;
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
    }

    /* Signals summary */
    .dd-signals-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        font-size: 12px;
        color: var(--text-muted);
    }

    .dd-signals-row span {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 600;
        color: var(--text-main);
    }

    /* Section divider */
    .dd-section-divider {
        border: none;
        border-top: 1px solid rgba(255,255,255,0.05);
        margin: 12px 0;
    }

    /* Progress */
    .progress-container {
        margin: 20px 0;
    }

    .progress-bar {
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: var(--accent-blue);
        transition: width 0.3s;
    }

    .progress-text {
        text-align: center;
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
    }

    .empty-state i {
        width: 48px;
        height: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        .dd-stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <i data-lucide="flask-conical" style="width:24px;height:24px;color:var(--accent-blue);"></i>
        Backtest Lab
    </div>
</div>

<div class="page-content">
    <!-- Configuration -->
    <div class="config-panel">
        <div class="config-group">
            <label class="config-label">Station</label>
            <select id="station-select" class="config-input">
                {% for sid in active_stations %}
                {% set stn = all_stations[sid] %}
                <option value="{{ sid }}">{{ sid }} - {{ stn.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">Start Date</label>
            <input type="date" id="start-date" class="config-input">
        </div>
        <div class="config-group">
            <label class="config-label">End Date</label>
            <input type="date" id="end-date" class="config-input">
        </div>
        <div class="config-group">
            <label class="config-label">Mode</label>
            <select id="mode-select" class="config-input">
                <option value="signal">Signal Only</option>
                <option value="execution">Execution Aware</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">Policy</label>
            <select id="policy-select" class="config-input">
                <option value="conservative">Conservative</option>
                <option value="aggressive">Aggressive</option>
                <option value="fade">Fade Event QC</option>
                <option value="maker_passive">Maker Passive</option>
                <option value="multi_bandit">Multi Bandit</option>
                <option value="toy_debug">Toy Debug</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">Selection Mode</label>
            <select id="selection-mode-select" class="config-input">
                <option value="static">Static</option>
                <option value="linucb">LinUCB</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">Risk Profile</label>
            <select id="risk-profile-select" class="config-input">
                <option value="risk_first">Risk First</option>
                <option value="pnl_first">PnL First</option>
                <option value="calibration_first">Calibration First</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">Report Level</label>
            <select id="report-level-select" class="config-input">
                <option value="summary">Summary</option>
                <option value="day_detail">Day Detail</option>
                <option value="full_timeline">Full Timeline</option>
            </select>
        </div>
        <button id="run-btn" class="run-btn">
            <i data-lucide="play" style="width:16px;height:16px;display:inline;margin-right:6px;"></i>
            Run Backtest
        </button>
    </div>

    <!-- Progress -->
    <div class="progress-container" id="progress-container" style="display: none;">
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progress-text">Preparing...</div>
    </div>

    <!-- Results -->
    <div class="results-panel" id="results-panel" style="display: none;">
        <div class="results-header">
            <div class="results-title">
                <i data-lucide="bar-chart-3"></i>
                Backtest Results
            </div>
            <span id="results-period" class="text-muted"></span>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid" id="summary-stats">
            <div class="stat-card trading-stat">
                <div class="label">Total PnL</div>
                <div class="value green" id="stat-pnl">$0.00</div>
            </div>
            <div class="stat-card trading-stat">
                <div class="label">Win Rate</div>
                <div class="value blue" id="stat-winrate">0%</div>
            </div>
            <div class="stat-card trading-stat">
                <div class="label">Sharpe</div>
                <div class="value" id="stat-sharpe">0.00</div>
            </div>
            <div class="stat-card trading-stat">
                <div class="label">Max Drawdown</div>
                <div class="value red" id="stat-dd">0%</div>
            </div>
            <div class="stat-card">
                <div class="label">Days</div>
                <div class="value" id="stat-days">0</div>
            </div>
            <div class="stat-card trading-stat">
                <div class="label">Total Fills</div>
                <div class="value" id="stat-fills">0</div>
            </div>
        </div>
        <!-- Coverage Info (Signal Only) -->
        <div id="coverage-info" style="display: none; margin-top: 10px;">
            <span class="text-muted">Coverage: <span id="coverage-labels">0</span>/<span id="coverage-total">0</span> days with labels</span>
        </div>

        <!-- Metrics -->
        <div class="metrics-grid">
            <div class="metric-section">
                <h3>Calibration Metrics</h3>
                <div class="metric-row">
                    <span class="metric-name">Brier Score</span>
                    <span class="metric-value" id="m-brier">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Log Loss</span>
                    <span class="metric-value" id="m-logloss">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">ECE</span>
                    <span class="metric-value" id="m-ece">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Sharpness</span>
                    <span class="metric-value" id="m-sharp">-</span>
                </div>
            </div>
            <div class="metric-section">
                <h3>Point Prediction</h3>
                <div class="metric-row">
                    <span class="metric-name">Tmax MAE</span>
                    <span class="metric-value" id="m-mae">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Tmax RMSE</span>
                    <span class="metric-value" id="m-rmse">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Tmax Bias</span>
                    <span class="metric-value" id="m-bias">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Avg Churn</span>
                    <span class="metric-value" id="m-churn">-</span>
                </div>
            </div>
        </div>

        <!-- Day Results Table -->
        <table class="day-table" id="day-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Date</th>
                    <th>Predicted</th>
                    <th>Actual</th>
                    <th>Pred Tmax</th>
                    <th>Actual Tmax</th>
                    <th>PnL</th>
                    <th>Coverage</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="day-tbody">
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state">
        <i data-lucide="flask-conical"></i>
        <h3>No Backtest Results</h3>
        <p>Configure parameters and click "Run Backtest" to start.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Set default dates
    const today = new Date();
    const endDate = new Date(today);
    endDate.setDate(endDate.getDate() - 1);

    const startDate = new Date(endDate);
    startDate.setDate(startDate.getDate() - 7);

    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];

    // Track expanded day and its chart instance
    let expandedDate = null;
    let activeChart = null;
    let lastResult = null;

    // Run backtest
    document.getElementById('run-btn').onclick = async function() {
        const station = document.getElementById('station-select').value;
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const mode = document.getElementById('mode-select').value;
        const policy = document.getElementById('policy-select').value;
        const selectionMode = document.getElementById('selection-mode-select').value;
        const riskProfile = document.getElementById('risk-profile-select').value;
        const reportLevel = document.getElementById('report-level-select').value;

        if (!start || !end) {
            alert('Please select start and end dates');
            return;
        }

        // Show progress
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('results-panel').style.display = 'none';
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-text').textContent = 'Starting backtest...';
        document.getElementById('run-btn').disabled = true;

        try {
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress = Math.min(progress + 5, 90);
                document.getElementById('progress-fill').style.width = progress + '%';
            }, 500);

            const params = new URLSearchParams({
                station_id: station,
                start_date: start,
                end_date: end,
                mode: mode,
                policy: policy,
                selection_mode: selectionMode,
                risk_profile: riskProfile,
                report_level: reportLevel
            });

            const resp = await fetch(`/api/v5/backtest/run?${params}`, {
                method: 'POST'
            });
            const result = await resp.json();

            // Check for error response
            if (!resp.ok || result.error) {
                throw new Error(result.error || `Server error: ${resp.status}`);
            }

            clearInterval(progressInterval);
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-text').textContent = 'Complete!';

            lastResult = result;

            // Display results
            setTimeout(() => {
                document.getElementById('progress-container').style.display = 'none';
                displayResults(result);
            }, 500);

        } catch (e) {
            console.error('Backtest failed:', e);
            alert('Backtest failed: ' + (e.message || 'Unknown error'));
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
        } finally {
            document.getElementById('run-btn').disabled = false;
        }
    };

    function displayResults(result) {
        document.getElementById('results-panel').style.display = 'block';
        expandedDate = null;
        if (activeChart) { activeChart.destroy(); activeChart = null; }

        // Period
        document.getElementById('results-period').textContent =
            `${result.config.start_date} to ${result.config.end_date}`;

        // Check if Signal Only mode
        const isSignalOnly = result.config.mode === 'signal_only';

        // Show/hide trading stats based on mode
        document.querySelectorAll('.trading-stat').forEach(el => {
            if (isSignalOnly) {
                el.querySelector('.value').textContent = 'N/A';
                el.querySelector('.value').className = 'value text-muted';
            }
        });

        // Coverage info
        const coverage = result.coverage || {};
        document.getElementById('stat-days').textContent = coverage.days_with_data || 0;
        document.getElementById('coverage-labels').textContent = coverage.days_with_labels || 0;
        document.getElementById('coverage-total').textContent = coverage.days_with_data || 0;
        document.getElementById('coverage-info').style.display = isSignalOnly ? 'block' : 'none';

        // Summary stats (only show in Execution mode)
        if (!isSignalOnly) {
            const trading = result.trading_summary || {};
            document.getElementById('stat-pnl').textContent =
                '$' + (trading.total_pnl_net || 0).toFixed(2);
            document.getElementById('stat-pnl').className =
                'value ' + (trading.total_pnl_net >= 0 ? 'green' : 'red');

            document.getElementById('stat-winrate').textContent =
                ((trading.win_rate || 0) * 100).toFixed(1) + '%';
            document.getElementById('stat-sharpe').textContent =
                (trading.sharpe_ratio || 0).toFixed(2);
            document.getElementById('stat-dd').textContent =
                ((trading.max_drawdown || 0) * 100).toFixed(1) + '%';
            document.getElementById('stat-fills').textContent =
                trading.total_fills || 0;
        }

        // Calibration metrics
        const metrics = result.aggregated_metrics || {};
        const cal = metrics.calibration || {};
        const point = metrics.point_metrics || {};
        const stability = metrics.stability || {};

        document.getElementById('m-brier').textContent =
            cal.brier_global?.toFixed(4) || '-';
        document.getElementById('m-logloss').textContent =
            cal.log_loss_global?.toFixed(4) || '-';
        document.getElementById('m-ece').textContent =
            cal.ece?.toFixed(4) || '-';
        document.getElementById('m-sharp').textContent =
            cal.sharpness?.toFixed(4) || '-';

        document.getElementById('m-mae').textContent =
            point.tmax_mae?.toFixed(2) + '\u00B0F' || '-';
        document.getElementById('m-rmse').textContent =
            point.tmax_rmse?.toFixed(2) + '\u00B0F' || '-';
        document.getElementById('m-bias').textContent =
            (point.tmax_bias >= 0 ? '+' : '') + point.tmax_bias?.toFixed(2) + '\u00B0F' || '-';
        document.getElementById('m-churn').textContent =
            stability.avg_churn?.toFixed(4) || '-';

        // Day results table
        const tbody = document.getElementById('day-tbody');
        tbody.innerHTML = '';

        for (const day of (result.day_results || [])) {
            const pred = day.predictions || {};
            const trading = day.trading || {};
            const cov = day.coverage || {};
            const status = day.status || 'ok';

            const correct = pred.predicted_winner === pred.actual_winner;

            // Coverage percentage
            const tlSteps = cov.timeline_steps || 0;
            const mktSteps = cov.timesteps_with_market || 0;
            const covPct = tlSteps > 0 ? Math.round((mktSteps / tlSteps) * 100) : 0;
            const covColor = covPct >= 70 ? '#10B981' : covPct >= 30 ? '#F4D03F' : '#EF4444';

            // Status badge class
            let badgeClass = 'ok';
            if (status === 'no_market_data') badgeClass = 'no_market_data';
            else if (status === 'integrity_warning') badgeClass = 'integrity_warning';
            else if (status === 'no_data') badgeClass = 'no_data';

            const tr = document.createElement('tr');
            tr.className = (correct ? 'correct' : 'wrong') + ' day-row';
            tr.dataset.date = day.market_date;
            tr.dataset.station = result.config.station_id;

            tr.innerHTML = `
                <td><span class="expand-icon">&#9654;</span></td>
                <td>${day.market_date}</td>
                <td>${pred.predicted_winner || '-'}</td>
                <td>${pred.actual_winner || '-'}</td>
                <td>${pred.predicted_tmax?.toFixed(1) || '-'}\u00B0F</td>
                <td>${pred.actual_tmax?.toFixed(1) || '-'}\u00B0F</td>
                <td>$${trading.pnl_net?.toFixed(2) || '0.00'}</td>
                <td>
                    <span class="coverage-bar-mini">
                        <span class="coverage-bar-mini-fill" style="width:${covPct}%;background:${covColor}"></span>
                    </span>
                    <span style="font-family:'JetBrains Mono',monospace;font-size:11px;">${covPct}%</span>
                </td>
                <td><span class="status-badge ${badgeClass}">${status.replace(/_/g, ' ')}</span></td>
            `;

            tr.onclick = () => toggleDayDetail(tr, day.market_date, result.config.station_id);
            tbody.appendChild(tr);
        }

        lucide.createIcons();
    }

    // ================================================================
    // Day Detail Drilldown
    // ================================================================

    async function toggleDayDetail(dayRow, dateStr, stationId) {
        const existingDetail = dayRow.nextElementSibling;

        // If already expanded, collapse
        if (existingDetail && existingDetail.classList.contains('day-detail-row')) {
            if (activeChart) { activeChart.destroy(); activeChart = null; }
            existingDetail.remove();
            dayRow.classList.remove('expanded');
            expandedDate = null;
            return;
        }

        // Collapse any other expanded row
        const prevExpanded = document.querySelector('.day-row.expanded');
        if (prevExpanded) {
            const prevDetail = prevExpanded.nextElementSibling;
            if (prevDetail && prevDetail.classList.contains('day-detail-row')) {
                prevDetail.remove();
            }
            prevExpanded.classList.remove('expanded');
        }
        if (activeChart) { activeChart.destroy(); activeChart = null; }

        // Mark as expanded
        dayRow.classList.add('expanded');
        expandedDate = dateStr;

        // Insert detail row
        const detailRow = document.createElement('tr');
        detailRow.className = 'day-detail-row';
        const detailTd = document.createElement('td');
        detailTd.colSpan = 9;
        detailTd.innerHTML = `
            <div class="day-detail-panel">
                <div class="day-detail-loading">Loading day detail...</div>
            </div>
        `;
        detailRow.appendChild(detailTd);
        dayRow.after(detailRow);

        // Fetch day detail data
        try {
            const params = new URLSearchParams({
                date: dateStr,
                downsample: '3'
            });
            const resp = await fetch(`/api/v5/backtest/day_detail/${stationId}?${params}`);
            const data = await resp.json();

            if (!resp.ok || data.error) {
                throw new Error(data.error || 'Failed to load day detail');
            }

            // Render the detail panel
            renderDayDetail(detailTd.querySelector('.day-detail-panel'), data);

        } catch (e) {
            detailTd.querySelector('.day-detail-panel').innerHTML = `
                <div class="day-detail-loading" style="color:#EF4444;">
                    Error: ${e.message}
                </div>
            `;
        }
    }

    function renderDayDetail(panel, data) {
        const cov = data.coverage || {};
        const outputs = data.outputs || {};
        const reasons = data.reason_counters || {};
        const summary = data.summary || {};
        const predictions = outputs.predictions || [];
        const fills = outputs.fills || [];
        const signalsTotal = outputs.signals_total || 0;
        const ordersCount = (outputs.orders || []).length;

        // Build HTML
        let html = '<div class="day-detail-content">';

        // === Coverage Stats Card ===
        const tlSteps = cov.timeline_steps || 0;
        const mktSteps = cov.timesteps_with_market || 0;
        const ncSteps = cov.timesteps_with_nowcast || 0;
        const mktPct = tlSteps > 0 ? Math.round((mktSteps / tlSteps) * 100) : 0;
        const ncPct = tlSteps > 0 ? Math.round((ncSteps / tlSteps) * 100) : 0;
        const statusBadge = summary.status || data.coverage?.status || 'ok';
        let badgeClass = 'ok';
        if (statusBadge === 'no_market_data') badgeClass = 'no_market_data';
        else if (statusBadge === 'integrity_warning') badgeClass = 'integrity_warning';

        html += `
            <div class="dd-stats-row">
                <div class="dd-stat">
                    <div class="dd-label">Timeline Steps</div>
                    <div class="dd-value">${tlSteps}</div>
                </div>
                <div class="dd-stat">
                    <div class="dd-label">Market Data</div>
                    <div class="dd-value" style="color:${mktPct >= 70 ? '#10B981' : mktPct >= 30 ? '#F4D03F' : '#EF4444'}">${mktPct}%</div>
                </div>
                <div class="dd-stat">
                    <div class="dd-label">Nowcast Data</div>
                    <div class="dd-value" style="color:${ncPct >= 70 ? '#10B981' : ncPct >= 30 ? '#F4D03F' : '#EF4444'}">${ncPct}%</div>
                </div>
                <div class="dd-stat">
                    <div class="dd-label">Predictions</div>
                    <div class="dd-value">${predictions.length}</div>
                </div>
                <div class="dd-stat">
                    <div class="dd-label">Status</div>
                    <div class="dd-value"><span class="status-badge ${badgeClass}">${(summary.status || 'ok').replace(/_/g, ' ')}</span></div>
                </div>
            </div>
        `;

        // === Signals Summary ===
        html += `
            <div class="dd-signals-row">
                Signals: <span>${signalsTotal}</span>
                &nbsp;&middot;&nbsp;
                Orders: <span>${ordersCount}</span>
                &nbsp;&middot;&nbsp;
                Fills: <span>${fills.length}</span>
            </div>
        `;

        // === Intraday Prediction Chart ===
        if (predictions.length > 0) {
            html += `
                <div class="dd-chart-title">Intraday Tmax Prediction</div>
                <div class="dd-chart-container">
                    <canvas id="dd-chart-${data.market_date}"></canvas>
                </div>
            `;
        }

        // === p_bucket Top-K Probability Chart ===
        if (predictions.length > 0 && predictions[0].p_bucket && predictions[0].p_bucket.length > 0) {
            html += `
                <div class="dd-chart-title">Bucket Probabilities (Top-5)</div>
                <div class="dd-chart-container">
                    <canvas id="dd-pbucket-chart-${data.market_date}"></canvas>
                </div>
            `;
        }

        // === Reason Counters ===
        const reasonEntries = Object.entries(reasons);
        if (reasonEntries.length > 0) {
            html += '<hr class="dd-section-divider">';
            html += '<div class="dd-reasons">';
            html += '<div class="dd-reasons-title">No-Trade Reasons</div>';
            html += '<div class="dd-reasons-grid">';
            // Sort by count descending
            reasonEntries.sort((a, b) => b[1] - a[1]);
            for (const [reason, count] of reasonEntries) {
                const label = reason.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                html += `<div class="dd-reason-chip"><span class="count">${count}</span> ${label}</div>`;
            }
            html += '</div></div>';
        }

        // === Fills Blotter ===
        html += '<hr class="dd-section-divider">';
        html += '<div class="dd-fills-title">Fills Blotter</div>';
        if (fills.length > 0) {
            html += `
                <table class="dd-fills-table">
                    <thead>
                        <tr>
                            <th>Time (UTC)</th>
                            <th>Bucket</th>
                            <th>Side</th>
                            <th>Size</th>
                            <th>Price</th>
                            <th>Fees</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            for (const f of fills) {
                const ts = f.timestamp_utc ? f.timestamp_utc.split('T')[1]?.substring(0, 8) || f.timestamp_utc : '-';
                const sideClass = f.side === 'buy' ? 'buy' : 'sell';
                html += `
                    <tr>
                        <td>${ts}</td>
                        <td>${f.bucket || '-'}</td>
                        <td class="${sideClass}">${(f.side || '-').toUpperCase()}</td>
                        <td>${(f.size || 0).toFixed(2)}</td>
                        <td>${(f.price || 0).toFixed(4)}</td>
                        <td>${(f.fees || 0).toFixed(4)}</td>
                        <td>${(f.fill_type || '-').replace(/_/g, ' ')}</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
        } else {
            html += '<div class="dd-empty">No fills for this day</div>';
        }

        html += '</div>'; // end day-detail-content
        panel.innerHTML = html;

        // === Render Charts ===
        if (predictions.length > 0) {
            renderIntradayChart(data.market_date, predictions, summary.actual_tmax, fills);
            renderPBucketChart(data.market_date, predictions, summary.actual_winner);
        }
    }

    function renderIntradayChart(dateStr, predictions, actualTmax, fills) {
        const canvasId = `dd-chart-${dateStr}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Extract data
        const labels = [];
        const means = [];
        const upperBand = [];
        const lowerBand = [];

        for (const p of predictions) {
            // Parse ts_nyc for display
            const tsNyc = p.ts_nyc || p.ts_utc;
            let timeLabel = '';
            if (tsNyc) {
                const dt = new Date(tsNyc);
                timeLabel = dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            }
            labels.push(timeLabel);

            const mean = p.tmax_mean;
            const sigma = p.tmax_sigma || 0;
            means.push(mean);
            upperBand.push(mean != null ? mean + sigma : null);
            lowerBand.push(mean != null ? mean - sigma : null);
        }

        // Fill markers (scatter points on the timeline)
        const fillPoints = [];
        if (fills && fills.length > 0) {
            for (const f of fills) {
                const fTs = f.timestamp_utc;
                if (!fTs) continue;
                const fDt = new Date(fTs);
                const fLabel = fDt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                // Find nearest label index
                let nearest = 0;
                let minDist = Infinity;
                for (let i = 0; i < labels.length; i++) {
                    // Simple string compare for proximity
                    if (labels[i] === fLabel) { nearest = i; break; }
                    const dist = Math.abs(labels[i].localeCompare(fLabel));
                    if (dist < minDist) { minDist = dist; nearest = i; }
                }
                fillPoints.push({
                    x: nearest,
                    y: means[nearest] || 0,
                    side: f.side,
                    bucket: f.bucket,
                    price: f.price
                });
            }
        }

        const datasets = [
            {
                label: 'Tmax Mean',
                data: means,
                borderColor: '#0078FF',
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 4,
                order: 2
            },
            {
                label: '+1\u03C3',
                data: upperBand,
                borderColor: 'transparent',
                backgroundColor: 'rgba(0, 120, 255, 0.1)',
                fill: '+1',
                borderWidth: 0,
                pointRadius: 0,
                order: 3
            },
            {
                label: '-1\u03C3',
                data: lowerBand,
                borderColor: 'transparent',
                backgroundColor: 'rgba(0, 120, 255, 0.1)',
                fill: '-1',
                borderWidth: 0,
                pointRadius: 0,
                order: 3
            }
        ];

        // Actual tmax horizontal line
        if (actualTmax != null) {
            datasets.push({
                label: 'Actual Tmax',
                data: Array(labels.length).fill(actualTmax),
                borderColor: '#EF4444',
                borderWidth: 1.5,
                borderDash: [6, 4],
                pointRadius: 0,
                fill: false,
                order: 1
            });
        }

        // Fill markers as scatter
        if (fillPoints.length > 0) {
            const buyPts = fillPoints.filter(p => p.side === 'buy');
            const sellPts = fillPoints.filter(p => p.side === 'sell');

            if (buyPts.length > 0) {
                datasets.push({
                    label: 'Buy Fill',
                    data: buyPts.map(p => ({ x: p.x, y: p.y })),
                    type: 'scatter',
                    backgroundColor: '#10B981',
                    borderColor: '#10B981',
                    pointRadius: 6,
                    pointStyle: 'triangle',
                    order: 0
                });
            }
            if (sellPts.length > 0) {
                datasets.push({
                    label: 'Sell Fill',
                    data: sellPts.map(p => ({ x: p.x, y: p.y })),
                    type: 'scatter',
                    backgroundColor: '#EF4444',
                    borderColor: '#EF4444',
                    pointRadius: 6,
                    pointStyle: 'triangleDown' ,
                    order: 0
                });
            }
        }

        if (activeChart) { activeChart.destroy(); activeChart = null; }

        activeChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#94a3b8',
                            font: { size: 11, family: 'Inter' },
                            boxWidth: 12,
                            padding: 10,
                            filter: function(item) {
                                // Hide sigma bands from legend
                                return item.text !== '+1\u03C3' && item.text !== '-1\u03C3';
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a2035',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        titleColor: '#f1f5f9',
                        bodyColor: '#94a3b8',
                        titleFont: { family: 'Inter', size: 12 },
                        bodyFont: { family: 'JetBrains Mono', size: 11 },
                        callbacks: {
                            label: function(ctx) {
                                if (ctx.dataset.label === '+1\u03C3' || ctx.dataset.label === '-1\u03C3') return null;
                                const val = ctx.parsed.y;
                                if (val == null) return null;
                                return `${ctx.dataset.label}: ${val.toFixed(1)}\u00B0F`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: {
                            color: '#64748b',
                            font: { size: 10, family: 'JetBrains Mono' },
                            maxTicksLimit: 12,
                            maxRotation: 0
                        }
                    },
                    y: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: {
                            color: '#64748b',
                            font: { size: 10, family: 'JetBrains Mono' },
                            callback: function(value) { return value + '\u00B0F'; }
                        }
                    }
                }
            }
        });
    }

    function renderPBucketChart(dateStr, predictions, actualWinner) {
        const canvasId = `dd-pbucket-chart-${dateStr}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Determine top-5 buckets by final prediction probabilities
        const lastPred = predictions[predictions.length - 1];
        if (!lastPred || !lastPred.p_bucket || lastPred.p_bucket.length === 0) return;

        const bucketsSorted = [...lastPred.p_bucket]
            .map((b, i) => ({ label: b.label, prob: b.prob || b.probability || 0, idx: i }))
            .sort((a, b) => b.prob - a.prob);
        const top5 = bucketsSorted.slice(0, 5);
        const top5Labels = top5.map(b => b.label);
        const top5Indices = top5.map(b => b.idx);

        // Build time labels (same as tmax chart)
        const timeLabels = [];
        for (const p of predictions) {
            const tsNyc = p.ts_nyc || p.ts_utc;
            let tl = '';
            if (tsNyc) {
                const dt = new Date(tsNyc);
                tl = dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            }
            timeLabels.push(tl);
        }

        // Colors for the 5 lines
        const colors = [
            '#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'
        ];

        // Build datasets for each of the top-5 buckets
        const datasets = top5.map((bucket, i) => {
            const data = predictions.map(p => {
                if (!p.p_bucket || !p.p_bucket[bucket.idx]) return null;
                const b = p.p_bucket[bucket.idx];
                return (b.prob || b.probability || 0) * 100;
            });
            const isActual = actualWinner && bucket.label === actualWinner;
            return {
                label: bucket.label + (isActual ? ' â˜…' : ''),
                data: data,
                borderColor: colors[i],
                backgroundColor: colors[i] + '20',
                borderWidth: isActual ? 2.5 : 1.5,
                borderDash: isActual ? [] : [4, 2],
                pointRadius: 0,
                tension: 0.3,
                fill: false,
            };
        });

        new Chart(ctx, {
            type: 'line',
            data: { labels: timeLabels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#94a3b8',
                            font: { size: 11, family: 'Inter' },
                            boxWidth: 12,
                            padding: 10,
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a2035',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        titleColor: '#f1f5f9',
                        bodyColor: '#94a3b8',
                        titleFont: { family: 'Inter', size: 12 },
                        bodyFont: { family: 'JetBrains Mono', size: 11 },
                        callbacks: {
                            label: function(ctx) {
                                const val = ctx.parsed.y;
                                if (val == null) return null;
                                return `${ctx.dataset.label}: ${val.toFixed(1)}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: {
                            color: '#64748b',
                            font: { size: 10, family: 'JetBrains Mono' },
                            maxTicksLimit: 12,
                            maxRotation: 0
                        }
                    },
                    y: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: {
                            color: '#64748b',
                            font: { size: 10, family: 'JetBrains Mono' },
                            callback: function(value) { return value + '%'; }
                        },
                        min: 0,
                        suggestedMax: 50,
                    }
                }
            }
        });
    }

    lucide.createIcons();
})();
</script>
{% endblock %}
