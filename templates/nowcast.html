{% extends "base.html" %}

{% block title %}HELIOS - Nowcast Engine{% endblock %}

{% block head_extra %}
<style>
    .nowcast-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .nowcast-panel {
        background: var(--bg-secondary);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 20px;
    }

    .nowcast-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .nowcast-panel-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nowcast-panel-title i {
        width: 18px;
        height: 18px;
        color: var(--accent-blue);
    }

    /* Central Estimate Card */
    .estimate-card {
        background: linear-gradient(135deg, rgba(0,120,255,0.15), rgba(0,212,255,0.05));
        border: 1px solid rgba(0,120,255,0.3);
        border-radius: 16px;
        padding: 25px;
        text-align: center;
        margin-bottom: 20px;
    }

    .estimate-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-bottom: 8px;
    }

    .estimate-value {
        font-size: 48px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: #0078FF;
        line-height: 1;
    }

    .estimate-uncertainty {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 8px;
    }

    .estimate-confidence {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 12px;
    }

    .confidence-high { background: rgba(16,185,129,0.2); color: #10B981; }
    .confidence-medium { background: rgba(244,208,63,0.2); color: #F4D03F; }
    .confidence-low { background: rgba(239,68,68,0.2); color: #EF4444; }

    /* Bucket Probability Bars */
    .bucket-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .bucket-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .bucket-label {
        width: 60px;
        font-size: 12px;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-secondary);
        text-align: right;
    }

    .bucket-bar-container {
        flex: 1;
        height: 24px;
        background: rgba(255,255,255,0.03);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .bucket-bar {
        height: 100%;
        background: linear-gradient(90deg, #0078FF, #00d4ff);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .bucket-bar.impossible {
        background: rgba(239,68,68,0.3);
    }

    .bucket-prob {
        width: 50px;
        font-size: 12px;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-main);
        text-align: left;
    }

    /* t_peak Histogram */
    .tpeak-histogram {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 120px;
        padding: 10px 0;
        gap: 4px;
    }

    .tpeak-bar-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
    }

    .tpeak-bar {
        width: 100%;
        background: linear-gradient(180deg, #8B5CF6, #6366F1);
        border-radius: 4px 4px 0 0;
        transition: height 0.5s ease;
    }

    .tpeak-bar.past {
        background: rgba(100,100,100,0.3);
    }

    .tpeak-label {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 4px;
        font-family: 'JetBrains Mono', monospace;
        text-align: center;
        line-height: 1.3;
    }

    .tpeak-label-nyc {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .tpeak-label-es {
        font-size: 8px;
        color: var(--text-muted);
        opacity: 0.7;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
    }

    .stat-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 6px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-value.positive { color: #10B981; }
    .stat-value.negative { color: #EF4444; }
    .stat-value.neutral { color: var(--text-main); }

    /* Explanations */
    .explanation-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .explanation-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        border-left: 3px solid var(--accent-blue);
    }

    .explanation-factor {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
        width: 80px;
    }

    .explanation-desc {
        flex: 1;
        font-size: 13px;
        color: var(--text-main);
    }

    .explanation-value {
        font-size: 14px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Station Selector */
    .station-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .station-btn {
        padding: 8px 20px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .station-btn:hover {
        background: rgba(255,255,255,0.1);
    }

    .station-btn.active {
        background: rgba(0,120,255,0.2);
        border-color: var(--accent-blue);
        color: var(--accent-blue);
    }

    /* Update Status */
    .update-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        color: var(--text-muted);
    }

    .update-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10B981;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Debug Link */
    .debug-link {
        font-size: 11px;
        color: var(--text-muted);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .debug-link:hover {
        color: var(--accent-blue);
    }

    /* Market Info Banner */
    .market-banner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        padding: 12px 20px;
        margin-bottom: 20px;
    }

    .market-info {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .market-date {
        display: flex;
        flex-direction: column;
    }

    .market-date-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
    }

    .market-date-value {
        font-size: 18px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-main);
    }

    .market-time {
        display: flex;
        flex-direction: column;
        padding-left: 20px;
        border-left: 1px solid rgba(255,255,255,0.1);
    }

    .market-time-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
    }

    .market-time-value {
        font-size: 14px;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-secondary);
    }

    .market-status {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .market-status-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .market-status-badge.live {
        background: rgba(16,185,129,0.2);
        color: #10B981;
    }

    .market-status-badge.live::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10B981;
        animation: pulse 2s infinite;
    }

    .market-status-badge.resolved {
        background: rgba(100,100,100,0.3);
        color: var(--text-muted);
    }

    .market-countdown {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .market-countdown-label {
        font-size: 10px;
        color: var(--text-muted);
    }

    .market-countdown-value {
        font-size: 14px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        color: var(--accent-blue);
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .nowcast-grid {
            grid-template-columns: 1fr;
        }
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <i data-lucide="activity" style="width:24px;height:24px;color:var(--accent-blue);"></i>
        Nowcast Engine
    </div>
    <div class="update-status">
        <span class="update-dot"></span>
        <span id="last-update">Loading...</span>
        <a href="/nowcast/debug" class="debug-link">
            <i data-lucide="bug" style="width:12px;height:12px;"></i>
            Debug
        </a>
    </div>
</div>

<div class="page-content">
    <!-- Station Selector -->
    <div class="station-selector" id="station-selector">
        <!-- Populated by JS -->
    </div>

    <!-- Market Info Banner -->
    <div class="market-banner">
        <div class="market-info">
            <div class="market-date">
                <span class="market-date-label">Settlement Date (NYC)</span>
                <span class="market-date-value" id="market-date">--</span>
            </div>
            <div class="market-time">
                <span class="market-time-label">Current Time NYC (ES)</span>
                <span class="market-time-value" id="market-time">--:-- (--:--)</span>
            </div>
        </div>
        <div class="market-status">
            <div class="market-countdown" id="market-countdown-container">
                <span class="market-countdown-label">Market closes in</span>
                <span class="market-countdown-value" id="market-countdown">--:--:--</span>
            </div>
            <div class="market-status-badge live" id="market-status-badge">
                LIVE
            </div>
        </div>
    </div>

    <!-- Central Estimate -->
    <div class="estimate-card">
        <div class="estimate-label">Predicted Maximum Temperature</div>
        <div class="estimate-value" id="tmax-mean">--°F</div>
        <div class="estimate-uncertainty" id="tmax-sigma">Uncertainty: ±--°F</div>
        <div class="estimate-confidence confidence-medium" id="confidence-badge">MEDIUM</div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Bias Applied</div>
            <div class="stat-value neutral" id="stat-bias">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Max Observed</div>
            <div class="stat-value neutral" id="stat-max-observed">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Expected Peak NYC (ES)</div>
            <div class="stat-value neutral" id="stat-peak-hour">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Base Forecast</div>
            <div class="stat-value neutral" id="stat-base-source">--</div>
        </div>
    </div>

    <div class="nowcast-grid">
        <!-- Bucket Probabilities -->
        <div class="nowcast-panel">
            <div class="nowcast-panel-header">
                <div class="nowcast-panel-title">
                    <i data-lucide="bar-chart"></i>
                    P(bucket) - Temperature Brackets
                </div>
            </div>
            <div class="bucket-container" id="bucket-container">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- t_peak Distribution -->
        <div class="nowcast-panel">
            <div class="nowcast-panel-header">
                <div class="nowcast-panel-title">
                    <i data-lucide="clock"></i>
                    t_peak - Time of Maximum (NYC)
                </div>
            </div>
            <div class="tpeak-histogram" id="tpeak-histogram">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Explanations -->
    <div class="nowcast-panel">
        <div class="nowcast-panel-header">
            <div class="nowcast-panel-title">
                <i data-lucide="info"></i>
                Key Factors
            </div>
        </div>
        <div class="explanation-list" id="explanation-list">
            <!-- Populated by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let currentStation = 'KLGA';
    let pollInterval = null;

    // Initialize
    async function init() {
        await loadStations();
        await loadNowcast();

        // Poll every 30 seconds
        pollInterval = setInterval(loadNowcast, 30000);

        // Update clock every second
        setInterval(updateMarketClock, 1000);
        updateMarketClock();
    }

    // Market clock and countdown
    function updateMarketClock() {
        const now = new Date();

        // Calculate NYC time (UTC-5, but handle DST)
        // Using Intl to get accurate NYC time
        const nycFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: 'America/New_York',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        const nycDateFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: 'America/New_York',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        const esFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: 'Europe/Madrid',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });

        const nycTime = nycFormatter.format(now);
        const esTime = esFormatter.format(now);
        const nycDateParts = nycDateFormatter.format(now).split('/');
        const nycDate = `${nycDateParts[2]}-${nycDateParts[0]}-${nycDateParts[1]}`;

        document.getElementById('market-time').textContent = `${nycTime} (${esTime})`;

        // Get NYC hour to determine market status
        const nycHour = parseInt(nycTime.split(':')[0]);
        const nycMin = parseInt(nycTime.split(':')[1]);
        const nycSec = parseInt(nycTime.split(':')[2]);

        // Market is LIVE from 00:00 to 23:59:59 NYC
        // After midnight NYC, the market for that day is resolved
        // Calculate seconds until midnight NYC
        const secondsUntilMidnight = (24 - nycHour - 1) * 3600 + (60 - nycMin - 1) * 60 + (60 - nycSec);

        const badge = document.getElementById('market-status-badge');
        const countdownContainer = document.getElementById('market-countdown-container');

        // Market is always live during the day, resolved after midnight
        // For simplicity: if we have a target_date from the API that matches today NYC = LIVE
        const isLive = true; // Will be updated by renderNowcast based on target_date

        if (secondsUntilMidnight > 0) {
            const hours = Math.floor(secondsUntilMidnight / 3600);
            const mins = Math.floor((secondsUntilMidnight % 3600) / 60);
            const secs = secondsUntilMidnight % 60;
            document.getElementById('market-countdown').textContent =
                `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            countdownContainer.style.display = 'flex';
        } else {
            countdownContainer.style.display = 'none';
        }
    }

    function updateMarketStatus(targetDate, tsNyc) {
        // Parse NYC date from ts_nyc (format: "2026-01-29 10:30:00")
        const currentNycDate = tsNyc ? tsNyc.split(' ')[0] : null;

        const badge = document.getElementById('market-status-badge');
        const countdownContainer = document.getElementById('market-countdown-container');

        // If target_date matches current NYC date, market is LIVE
        // If target_date is in the past (NYC time), market is RESOLVED
        if (targetDate && currentNycDate) {
            if (targetDate === currentNycDate) {
                badge.className = 'market-status-badge live';
                badge.textContent = 'LIVE';
                countdownContainer.style.display = 'flex';
            } else if (targetDate < currentNycDate) {
                badge.className = 'market-status-badge resolved';
                badge.textContent = 'RESOLVED';
                countdownContainer.style.display = 'none';
            } else {
                // Future market
                badge.className = 'market-status-badge';
                badge.style.background = 'rgba(59,130,246,0.2)';
                badge.style.color = '#3B82F6';
                badge.textContent = 'PENDING';
                countdownContainer.style.display = 'none';
            }
        }

        // Update the market date display with ES equivalent
        if (targetDate) {
            // Get current ES date for comparison
            const now = new Date();
            const esDateFormatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Europe/Madrid',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const currentEsDate = esDateFormatter.format(now);

            // Format target date nicely
            const [year, month, day] = targetDate.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const nycFormatted = `${parseInt(day)} ${months[parseInt(month)-1]} ${year}`;

            // Show ES date if it differs from NYC settlement date
            if (currentEsDate !== targetDate) {
                const [esYear, esMonth, esDay] = currentEsDate.split('-');
                const esFormatted = `${parseInt(esDay)} ${months[parseInt(esMonth)-1]}`;
                document.getElementById('market-date').innerHTML =
                    `${nycFormatted} <span style="color:var(--text-muted);font-size:12px;">(ES: ${esFormatted})</span>`;
            } else {
                document.getElementById('market-date').textContent = nycFormatted;
            }
        }
    }

    async function loadStations() {
        try {
            const resp = await fetch('/api/stations');
            const stations = await resp.json();

            const container = document.getElementById('station-selector');
            container.innerHTML = '';

            for (const stn of stations) {
                const btn = document.createElement('button');
                btn.className = 'station-btn' + (stn.id === currentStation ? ' active' : '');
                btn.textContent = stn.id;
                btn.onclick = () => selectStation(stn.id);
                container.appendChild(btn);
            }
        } catch (e) {
            console.error('Failed to load stations:', e);
        }
    }

    function selectStation(stationId) {
        currentStation = stationId;

        // Update buttons
        document.querySelectorAll('.station-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === stationId);
        });

        loadNowcast();
    }

    async function loadNowcast() {
        try {
            // Fetch both distribution and state in parallel
            const [distResp, stateResp] = await Promise.all([
                fetch(`/api/v3/nowcast/${currentStation}`),
                fetch(`/api/v3/nowcast/${currentStation}/state`)
            ]);

            const data = await distResp.json();
            const state = await stateResp.json();

            if (data.error) {
                console.warn('Nowcast error:', data.error);
                return;
            }

            renderNowcast(data, state);

            // Update timestamp - show NYC time from data
            const updateTime = data.ts_nyc ?
                `${data.ts_nyc.split(' ')[1]} NYC` :
                new Date().toLocaleTimeString();
            document.getElementById('last-update').textContent = `Updated: ${updateTime}`;

        } catch (e) {
            console.error('Failed to load nowcast:', e);
        }
    }

    function renderNowcast(data, state) {
        // Update market status banner
        updateMarketStatus(data.target_date, data.ts_nyc);

        // Central estimate
        document.getElementById('tmax-mean').textContent =
            data.tmax_mean_f ? `${data.tmax_mean_f.toFixed(1)}°F` : '--°F';
        document.getElementById('tmax-sigma').textContent =
            data.tmax_sigma_f ? `Uncertainty: ±${data.tmax_sigma_f.toFixed(1)}°F` : 'Uncertainty: --';

        // Max observed from state
        const maxObs = state && state.max_so_far_f !== undefined && state.max_so_far_f > -900
            ? state.max_so_far_f.toFixed(0)
            : '--';
        document.getElementById('stat-max-observed').textContent = maxObs !== '--' ? `${maxObs}°F` : '--';

        // Confidence badge
        const badge = document.getElementById('confidence-badge');
        const conf = data.confidence || 0.5;
        badge.className = 'estimate-confidence ';
        if (conf >= 0.7) {
            badge.className += 'confidence-high';
            badge.textContent = `HIGH (${(conf * 100).toFixed(0)}%)`;
        } else if (conf >= 0.4) {
            badge.className += 'confidence-medium';
            badge.textContent = `MEDIUM (${(conf * 100).toFixed(0)}%)`;
        } else {
            badge.className += 'confidence-low';
            badge.textContent = `LOW (${(conf * 100).toFixed(0)}%)`;
        }

        // Stats
        const bias = data.bias_applied_f || 0;
        document.getElementById('stat-bias').textContent =
            `${bias >= 0 ? '+' : ''}${bias.toFixed(1)}°F`;
        document.getElementById('stat-bias').className =
            'stat-value ' + (bias > 0 ? 'positive' : bias < 0 ? 'negative' : 'neutral');

        // Expected peak hour with both timezones
        if (data.t_peak_expected_hour !== undefined) {
            const peakNyc = data.t_peak_expected_hour;
            const peakEs = (peakNyc + 6) % 24;  // NYC + 6 = ES
            document.getElementById('stat-peak-hour').textContent =
                `${peakNyc}:00 (${peakEs}:00)`;
        } else {
            document.getElementById('stat-peak-hour').textContent = '--';
        }

        document.getElementById('stat-base-source').textContent =
            data.base_forecast_source || '--';

        // Bucket probabilities
        renderBuckets(data.p_bucket || []);

        // Calculate current NYC hour from ts_nyc if available
        let currentNycHour = 12; // default
        if (data.ts_nyc) {
            // ts_nyc format: "2026-01-29 10:30:00"
            const timePart = data.ts_nyc.split(' ')[1];
            if (timePart) {
                currentNycHour = parseInt(timePart.split(':')[0]);
            }
        }

        // t_peak histogram with NYC hour
        renderTPeak(data.t_peak_bins || [], currentNycHour);

        // Explanations
        renderExplanations(data.explanations || []);
    }

    function renderBuckets(buckets) {
        const container = document.getElementById('bucket-container');
        container.innerHTML = '';

        const bucketSortValue = (label) => {
            if (!label) return -9999;
            const match = String(label).match(/-?\d+/);
            return match ? parseInt(match[0], 10) : -9999;
        };

        const bucketDisplayLabel = (bucket) => {
            const raw = bucket && bucket.label ? String(bucket.label) : '';
            if (raw) {
                return raw.includes('°') ? raw : `${raw}°F`;
            }
            if (bucket && Number.isFinite(bucket.bucket_low_f) && Number.isFinite(bucket.bucket_high_f)) {
                return `${bucket.bucket_low_f}-${bucket.bucket_high_f}°F`;
            }
            return '--';
        };

        // Sort by bucket label (descending)
        buckets.sort((a, b) => {
            const aLow = bucketSortValue(a && a.label);
            const bLow = bucketSortValue(b && b.label);
            return bLow - aLow;
        });

        for (const bucket of buckets) {
            const prob = bucket.probability || 0;
            const pct = (prob * 100).toFixed(1);

            const row = document.createElement('div');
            row.className = 'bucket-row';
            row.innerHTML = `
                <div class="bucket-label">${bucketDisplayLabel(bucket)}</div>
                <div class="bucket-bar-container">
                    <div class="bucket-bar ${bucket.is_impossible ? 'impossible' : ''}"
                         style="width: ${Math.max(prob * 100, 1)}%"></div>
                </div>
                <div class="bucket-prob">${pct}%</div>
            `;
            container.appendChild(row);
        }
    }

    function renderTPeak(bins, currentNycHour) {
        const container = document.getElementById('tpeak-histogram');
        container.innerHTML = '';

        const maxProb = Math.max(...bins.map(b => b.probability || 0), 0.01);

        for (const bin of bins) {
            const prob = bin.probability || 0;
            const height = (prob / maxProb) * 100;
            // Use NYC hour from data for past check
            const binStartNyc = bin.bin_start_hour_nyc !== undefined ? bin.bin_start_hour_nyc : 0;
            const isPast = binStartNyc < currentNycHour;

            // Extract short labels (just the hours)
            const nycLabel = bin.label_short || bin.label_nyc || '--';
            const esLabel = bin.label_es ? bin.label_es.split('-')[0] : '';

            const wrapper = document.createElement('div');
            wrapper.className = 'tpeak-bar-wrapper';
            wrapper.innerHTML = `
                <div class="tpeak-bar ${isPast ? 'past' : ''}"
                     style="height: ${Math.max(height, 5)}%"
                     title="${bin.label || ''}"></div>
                <div class="tpeak-label">
                    <span class="tpeak-label-nyc">${nycLabel}</span><br>
                    <span class="tpeak-label-es">(${esLabel})</span>
                </div>
            `;
            container.appendChild(wrapper);
        }
    }

    function renderExplanations(explanations) {
        const container = document.getElementById('explanation-list');
        container.innerHTML = '';

        if (explanations.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">No significant factors</div>';
            return;
        }

        for (const exp of explanations) {
            const item = document.createElement('div');
            item.className = 'explanation-item';

            const valueClass = exp.contribution_f > 0 ? 'positive' :
                              exp.contribution_f < 0 ? 'negative' : 'neutral';
            const valueText = exp.contribution_f !== 0 ?
                `${exp.contribution_f >= 0 ? '+' : ''}${exp.contribution_f.toFixed(1)}°F` : '';

            item.innerHTML = `
                <div class="explanation-factor">${exp.factor}</div>
                <div class="explanation-desc">${exp.description}</div>
                <div class="explanation-value ${valueClass}">${valueText}</div>
            `;
            container.appendChild(item);
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (pollInterval) clearInterval(pollInterval);
    });

    // Start
    document.addEventListener('DOMContentLoaded', init);
    lucide.createIcons();
})();
</script>
{% endblock %}
