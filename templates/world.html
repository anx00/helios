{% extends "base.html" %}

{% block title %}HELIOS - World State{% endblock %}

{% block head_extra %}
<style>
    .world-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .world-panel {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 22px;
        transition: border-color 0.3s;
        min-height: 180px;
        overflow: hidden;
    }

    .world-panel:hover {
        border-color: rgba(255, 255, 255, 0.12);
    }

    .world-panel.full-width {
        grid-column: 1 / -1;
    }

    .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
    }

    .panel-title {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .panel-badge {
        font-size: 10px;
        padding: 3px 10px;
        border-radius: 20px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .badge-live {
        background: rgba(16, 185, 129, 0.15);
        color: #10B981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-ok {
        background: rgba(0, 120, 255, 0.15);
        color: #0078FF;
        border: 1px solid rgba(0, 120, 255, 0.3);
    }

    .badge-stale {
        background: rgba(244, 208, 63, 0.15);
        color: #F4D03F;
        border: 1px solid rgba(244, 208, 63, 0.3);
    }

    .badge-dead {
        background: rgba(239, 68, 68, 0.15);
        color: #EF4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .badge-no-data {
        background: rgba(100, 116, 139, 0.15);
        color: #64748b;
        border: 1px solid rgba(100, 116, 139, 0.3);
    }

    /* METAR Panel */
    .metar-main {
        display: flex;
        align-items: baseline;
        gap: 12px;
        margin-bottom: 16px;
    }

    .metar-temp {
        font-size: 48px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
        background: linear-gradient(135deg, #10B981, #0078FF);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .metar-unit {
        font-size: 20px;
        color: var(--text-secondary);
    }

    .metar-age-live {
        font-size: 14px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        margin-left: 8px;
        padding: 3px 10px;
        border-radius: 8px;
        transition: color 0.3s, background 0.3s;
    }

    .metar-age-live.fresh {
        color: #EF4444;
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.25);
        animation: pulse-red 2s infinite;
    }

    .metar-age-live.recent {
        color: #10B981;
        background: rgba(16, 185, 129, 0.10);
        border: 1px solid rgba(16, 185, 129, 0.20);
    }

    .metar-age-live.aging {
        color: #F4D03F;
        background: rgba(244, 208, 63, 0.10);
        border: 1px solid rgba(244, 208, 63, 0.20);
    }

    .metar-age-live.stale {
        color: #F97316;
        background: rgba(249, 115, 22, 0.10);
        border: 1px solid rgba(249, 115, 22, 0.20);
    }

    .metar-age-live.normal {
        color: var(--text-muted);
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .metar-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        font-weight: 600;
    }

    .detail-value {
        font-size: 15px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-main);
    }

    .detail-value.muted {
        color: var(--text-muted);
    }

    /* Timestamps */
    .timestamps-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        padding-top: 14px;
        margin-top: 14px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .ts-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-muted);
    }

    .ts-flag {
        font-size: 14px;
    }

    .ts-value {
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-secondary);
    }

    /* Daily Max Row */
    .daily-max-row {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 10px 14px;
        margin-bottom: 16px;
        background: rgba(249, 115, 22, 0.06);
        border: 1px solid rgba(249, 115, 22, 0.18);
        border-radius: 10px;
    }

    .daily-max-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #F97316;
        font-weight: 700;
    }

    .daily-max-value {
        font-size: 22px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
        color: #F97316;
    }

    .daily-max-meta {
        font-size: 11px;
        color: var(--text-muted);
        font-family: 'JetBrains Mono', monospace;
    }

    /* METAR History Table */
    .metar-history-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

    .metar-history-table th {
        text-align: left;
        padding: 8px 10px;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        font-weight: 600;
        background: rgba(255, 255, 255, 0.02);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .metar-history-table td {
        padding: 7px 10px;
        font-family: 'JetBrains Mono', monospace;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .metar-history-table tr.is-max td {
        background: rgba(249, 115, 22, 0.08);
    }

    .metar-history-table .temp-max-marker {
        color: #F97316;
        font-weight: 700;
    }

    /* Env Feature Cards */
    .env-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .env-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 16px;
    }

    .env-value {
        font-size: 28px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
        margin: 8px 0;
    }

    .env-meta {
        font-size: 11px;
        color: var(--text-muted);
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    /* QC Panel */
    .qc-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .qc-station {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .qc-station-id {
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        font-size: 14px;
    }

    .qc-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .qc-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .qc-dot.ok { background: #10B981; }
    .qc-dot.uncertain { background: #F4D03F; }
    .qc-dot.outlier { background: #EF4444; }
    .qc-dot.severe { background: #DC143C; animation: pulse-red 2s infinite; }

    @keyframes pulse-red {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.7); }
        50% { box-shadow: 0 0 0 6px rgba(220, 20, 60, 0); }
    }

    .qc-flags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .qc-flag {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 6px;
        background: rgba(239, 68, 68, 0.1);
        color: #EF4444;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Health Table */
    .health-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .health-table th {
        text-align: left;
        padding: 10px 14px;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        font-weight: 600;
        background: rgba(255, 255, 255, 0.02);
    }

    .health-table td {
        padding: 10px 14px;
        font-size: 13px;
        font-family: 'JetBrains Mono', monospace;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .health-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
    }

    .health-dot.live { background: #10B981; }
    .health-dot.ok { background: #0078FF; }
    .health-dot.stale { background: #F4D03F; }
    .health-dot.dead { background: #EF4444; }
    .health-dot.no-data { background: #64748b; }

    /* System Status Bar */
    .system-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 12px;
    }

    .system-bar-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .system-bar-item {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
    }

    .system-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10B981;
        animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
        0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
    }

    .sse-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-muted);
    }

    .sse-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #64748b;
    }

    .sse-dot.connected {
        background: #10B981;
        animation: pulse-green 2s infinite;
    }

    /* Upstream AuxObs */
    .aux-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .aux-id {
        font-weight: 600;
        font-size: 13px;
    }

    .aux-temp {
        font-size: 20px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
    }

    .aux-drift {
        font-size: 12px;
        font-family: 'JetBrains Mono', monospace;
    }

    .aux-drift.positive { color: #EF4444; }
    .aux-drift.negative { color: #0078FF; }
    .aux-drift.neutral { color: var(--text-muted); }

    /* PWS Sortable Table */
    .pws-sort-active {
        color: #8B5CF6 !important;
        font-weight: 700;
    }

    .pws-table th[onclick] {
        cursor: pointer;
        user-select: none;
        transition: color 0.2s, background 0.2s;
    }

    .pws-table th[onclick]:hover {
        color: #8B5CF6;
        background: rgba(139, 92, 246, 0.1);
    }

    .pws-filter-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }

    .pws-filter-chip {
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.03);
        color: var(--text-secondary);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
    }

    .pws-filter-chip.active {
        border-color: rgba(139,92,246,0.45);
        background: rgba(139,92,246,0.18);
        color: #C4B5FD;
    }

    .pws-filter-help {
        font-size: 11px;
        color: var(--text-muted);
    }

    /* Station Selector */
    .station-selector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .station-btn {
        padding: 8px 20px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .station-btn:hover {
        background: rgba(255,255,255,0.1);
    }

    .station-btn.active {
        background: rgba(0,120,255,0.2);
        border-color: var(--accent-blue);
        color: var(--accent-blue);
    }

    /* Responsive */
    @media (max-width: 900px) {
        .world-grid {
            grid-template-columns: 1fr;
        }
        .metar-details {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <i data-lucide="globe" style="width:24px;height:24px;color:var(--accent-blue);"></i>
        World State
    </div>
    <div class="breadcrumbs">
        <a href="/">Home</a> / <span>World State (Phase 2)</span>
    </div>
</div>

<div class="page-content">
    <!-- Station Selector -->
    <div class="station-selector" id="station-selector">
        <!-- Populated by JS -->
    </div>

    <!-- System Status Bar -->
    <div class="system-bar" id="system-bar">
        <div class="system-bar-left">
            <div class="system-bar-item">
                <div class="system-dot" id="system-dot"></div>
                <span id="system-status-text">Connecting...</span>
            </div>
            <div class="system-bar-item">
                <span id="ts-local-label">Local</span>
                <span class="ts-value" id="ts-local">--</span>
            </div>
            <div class="system-bar-item">
                <span>ES</span>
                <span class="ts-value" id="ts-madrid">--</span>
            </div>
            <div class="system-bar-item">
                <span>UTC</span>
                <span class="ts-value" id="ts-utc">--</span>
            </div>
        </div>
        <div class="sse-status">
            <div class="sse-dot" id="sse-dot"></div>
            <span id="sse-label">SSE Off</span>
        </div>
    </div>

    <div class="world-grid">
        <!-- ============================== -->
        <!-- METAR Panel (per station)      -->
        <!-- ============================== -->
        <div class="world-panel" id="panel-metar">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="radio-tower" style="width:16px;height:16px;"></i>
                    METAR Official
                </span>
                <span class="panel-badge badge-no-data" id="metar-badge">NO DATA</span>
            </div>
            <div id="metar-content">
                <div class="metar-main">
                    <span class="metar-temp" id="metar-temp">--</span>
                    <span class="metar-unit" id="metar-unit">F</span>
                    <span class="metar-age-live normal" id="metar-age-live"></span>
                </div>
                <div class="daily-max-row" id="daily-max-row" style="display:none;">
                    <div>
                        <div class="daily-max-label">Daily Max (NOAA)</div>
                    </div>
                    <div class="daily-max-value" id="daily-max-temp">--</div>
                    <div>
                        <div class="daily-max-meta" id="daily-max-raw">--</div>
                        <div class="daily-max-meta" id="daily-max-time">--</div>
                    </div>
                </div>
                <div class="metar-details">
                    <div class="detail-item">
                        <span class="detail-label">Station</span>
                        <span class="detail-value" id="metar-station">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Source</span>
                        <span class="detail-value" id="metar-source">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Source Age</span>
                        <span class="detail-value" id="metar-age">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Temp C</span>
                        <span class="detail-value" id="metar-temp-c">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Settlement</span>
                        <span class="detail-value" id="metar-settlement" style="color:#10B981;">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Dewpoint</span>
                        <span class="detail-value" id="metar-dewpoint">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Wind</span>
                        <span class="detail-value" id="metar-wind">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Sky</span>
                        <span class="detail-value" id="metar-sky">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">QC</span>
                        <span class="detail-value" id="metar-qc">--</span>
                    </div>
                </div>
                <div class="timestamps-row">
                    <div class="ts-item">
                        <span class="ts-flag">Obs UTC</span>
                        <span class="ts-value" id="metar-obs-utc">--</span>
                    </div>
                    <div class="ts-item">
                        <span class="ts-flag" id="metar-obs-local-label">Local</span>
                        <span class="ts-value" id="metar-obs-local">--</span>
                    </div>
                    <div class="ts-item">
                        <span class="ts-flag">ES</span>
                        <span class="ts-value" id="metar-obs-mad">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================== -->
        <!-- METAR History Panel (Today)    -->
        <!-- ============================== -->
        <div class="world-panel" id="panel-metar-history">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="clock" style="width:16px;height:16px;"></i>
                    METAR Today
                </span>
                <span style="font-size: 11px; color: var(--text-muted);" id="metar-history-count">--</span>
            </div>
            <div id="metar-history-content" style="max-height: 500px; overflow-y: auto;">
                <p style="color: var(--text-muted); font-size: 13px;">Loading...</p>
            </div>
        </div>

        <!-- ============================== -->
        <!-- Upstream / Aux Obs Panel       -->
        <!-- ============================== -->
        <div class="world-panel" id="panel-aux" style="display:none;">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="wind" style="width:16px;height:16px;"></i>
                    Upstream / Auxiliary
                </span>
                <span class="panel-badge badge-no-data" id="aux-badge">NO DATA</span>
            </div>
            <div id="aux-content">
                <p style="color: var(--text-muted); font-size: 13px;">No auxiliary observations yet.</p>
            </div>
        </div>

        <!-- ============================== -->
        <!-- PWS Consensus Panel            -->
        <!-- ============================== -->
        <div class="world-panel full-width" id="panel-pws">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="users" style="width:16px;height:16px;"></i>
                    PWS Consensus
                </span>
                <span class="panel-badge badge-no-data" id="pws-badge">NO DATA</span>
            </div>
            <div id="pws-filters" class="pws-filter-row"></div>
            <div id="pws-content">
                <p style="color: var(--text-muted); font-size: 13px;">No PWS cluster data yet. Appears after first prediction cycle.</p>
            </div>
        </div>

        <!-- ============================== -->
        <!-- Environment Features Panel     -->
        <!-- ============================== -->
        <div class="world-panel" id="panel-env">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="thermometer" style="width:16px;height:16px;"></i>
                    Environment Features
                </span>
            </div>
            <div class="env-grid" id="env-content">
                <!-- SST -->
                <div class="env-card" id="env-sst">
                    <div class="detail-label">SST (Sea Surface Temp)</div>
                    <div class="env-value" id="env-sst-value" style="color: #0078FF;">--</div>
                    <div class="env-meta">
                        <span id="env-sst-source">Source: --</span>
                        <span id="env-sst-age">Age: --</span>
                        <span id="env-sst-location">Location: --</span>
                    </div>
                </div>
                <!-- AOD -->
                <div class="env-card" id="env-aod">
                    <div class="detail-label">AOD (Aerosol Optical Depth)</div>
                    <div class="env-value" id="env-aod-value" style="color: #F4D03F;">--</div>
                    <div class="env-meta">
                        <span id="env-aod-source">Source: --</span>
                        <span id="env-aod-age">Age: --</span>
                        <span id="env-aod-location">Location: --</span>
                    </div>
                </div>
            </div>
            <div class="timestamps-row" id="env-timestamps">
                <div class="ts-item">
                    <span class="ts-flag" id="env-ts-local-label">Local</span>
                    <span class="ts-value" id="env-ts-local">--</span>
                </div>
                <div class="ts-item">
                    <span class="ts-flag">ES</span>
                    <span class="ts-value" id="env-ts-mad">--</span>
                </div>
            </div>
        </div>

        <!-- ============================== -->
        <!-- QC Panel                       -->
        <!-- ============================== -->
        <div class="world-panel" id="panel-qc">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="shield-check" style="width:16px;height:16px;"></i>
                    Quality Control
                </span>
            </div>
            <div class="qc-grid" id="qc-content">
                <p style="color: var(--text-muted); font-size: 13px;">No QC data yet.</p>
            </div>
        </div>

        <!-- ============================== -->
        <!-- Health Panel (full width)      -->
        <!-- ============================== -->
        <div class="world-panel full-width" id="panel-health">
            <div class="panel-header">
                <span class="panel-title">
                    <i data-lucide="activity" style="width:16px;height:16px;"></i>
                    Source Health &amp; Latency
                </span>
                <span style="font-size: 11px; color: var(--text-muted);" id="health-tape-count">Tape: 0 events</span>
            </div>
            <table class="health-table" id="health-table">
                <thead>
                    <tr>
                        <th style="width:22%">Source</th>
                        <th style="width:12%">Status</th>
                        <th style="width:12%">Staleness</th>
                        <th style="width:12%">Source Age</th>
                        <th style="width:10%">Updates</th>
                        <th style="width:18%">Errors</th>
                        <th style="width:14%">Last Seen (UTC)</th>
                    </tr>
                </thead>
                <tbody id="health-tbody">
                    <tr>
                        <td colspan="7" style="color: var(--text-muted); text-align: center;">No sources registered yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // State
    let evtSource = null;
    let lastSnapshot = null;
    let lastSnapshotHash = '';  // Fingerprint to skip redundant re-renders
    let sseConnected = false;
    let metarObsTimeUtc = null;  // Store obs time for live age calculation
    let currentStation = (window.HeliosStationState && window.HeliosStationState.get())
        ? window.HeliosStationState.get()
        : 'KLGA';  // Default station

    // Station timezone + market-unit info
    const stationTimezones = {};    // stationId -> IANA timezone
    const stationMarketUnits = {};  // stationId -> 'F' | 'C'
    const TZ_LABELS = {
        'KLGA': 'NYC',
        'KATL': 'ATL',
        'KORD': 'CHI',
        'KMIA': 'MIA',
        'KDAL': 'DAL',
        'LFPG': 'PAR',
        'EGLC': 'LON',
        'LTAC': 'ANK'
    };
    const ES_TZ = 'Europe/Madrid';

    // Dynamic formatters (rebuilt when station changes)
    let localTimeFormatter = null;
    let esTimeFormatter = null;
    let localTzLabel = 'NYC';

    function getStationMarketUnit(stationId = currentStation) {
        const raw = String(stationMarketUnits[stationId] || '').toUpperCase();
        if (raw === 'C' || raw === 'CELSIUS') return 'C';
        return (stationId === 'EGLC' || stationId === 'LTAC' || stationId === 'LFPG') ? 'C' : 'F';
    }

    function usesCelsius(stationId = currentStation) {
        return getStationMarketUnit(stationId) === 'C';
    }

    function tempUnitSymbol(stationId = currentStation) {
        return usesCelsius(stationId) ? '°C' : '°F';
    }

    function numericOrNaN(value) {
        if (value === null || value === undefined || value === '') return NaN;
        const n = Number(value);
        return Number.isFinite(n) ? n : NaN;
    }

    function fToC(tempF) {
        return (Number(tempF) - 32) * (5 / 9);
    }

    function convertTempFromF(tempF, stationId = currentStation) {
        if (!Number.isFinite(Number(tempF))) return null;
        const value = Number(tempF);
        return usesCelsius(stationId) ? fToC(value) : value;
    }

    function formatTempFromF(tempF, digits = 1, stationId = currentStation) {
        const v = convertTempFromF(tempF, stationId);
        if (v == null) return '--';
        return `${v.toFixed(digits)}${tempUnitSymbol(stationId)}`;
    }

    function updateTimezoneFormatters() {
        const tz = stationTimezones[currentStation] || 'America/New_York';
        localTzLabel = TZ_LABELS[currentStation] || currentStation;

        localTimeFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: tz,
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        });
        esTimeFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: ES_TZ,
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        });

        // Update labels in system bar and panels
        const localLabel = document.getElementById('ts-local-label');
        if (localLabel) localLabel.textContent = localTzLabel;
        const metarLocalLabel = document.getElementById('metar-obs-local-label');
        if (metarLocalLabel) metarLocalLabel.textContent = localTzLabel;
        const envLocalLabel = document.getElementById('env-ts-local-label');
        if (envLocalLabel) envLocalLabel.textContent = localTzLabel;
        const metarUnit = document.getElementById('metar-unit');
        if (metarUnit) metarUnit.textContent = usesCelsius() ? 'C' : 'F';
    }

    function formatTimeInTz(isoUtc, formatter) {
        if (!isoUtc || !formatter) return '--';
        try {
            const d = new Date(isoUtc);
            if (isNaN(d.getTime())) return '--';
            return formatter.format(d);
        } catch { return '--'; }
    }

    // === Station Selector ===
    async function loadStations() {
        try {
            const resp = await fetch('/api/stations');
            const stations = await resp.json();
            if (!stations || stations.length === 0) return;

            const globalSelected = window.HeliosStationState?.get?.();
            if (globalSelected) currentStation = globalSelected;

            // Store timezone info per station
            for (const stn of stations) {
                stationTimezones[stn.id] = stn.timezone;
                const unit = String(stn.market_unit || '').toUpperCase();
                if (unit === 'C' || unit === 'F') {
                    stationMarketUnits[stn.id] = unit;
                }
            }

            // If current station not in list, switch to first before rendering buttons
            if (!stations.find(s => s.id === currentStation) && stations.length > 0) {
                currentStation = stations[0].id;
            }

            const container = document.getElementById('station-selector');
            container.innerHTML = '';

            for (const stn of stations) {
                const btn = document.createElement('button');
                btn.className = 'station-btn' + (stn.id === currentStation ? ' active' : '');
                btn.dataset.stationId = stn.id;
                btn.textContent = stn.display_label || `${stn.id}`;
                btn.onclick = () => selectStation(stn.id);
                container.appendChild(btn);
            }

            updateTimezoneFormatters();
        } catch (e) {
            console.error('Failed to load stations:', e);
        }
    }

    function selectStation(stationId) {
        const normalized = window.HeliosStationState?.normalize?.(stationId) || String(stationId || '').toUpperCase();
        currentStation = normalized;

        // Update buttons
        document.querySelectorAll('.station-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.stationId === currentStation);
        });

        window.HeliosStationState?.set?.(currentStation, { source: 'world' });

        // Update timezone formatters
        updateTimezoneFormatters();

        // Re-render with existing data
        if (lastSnapshot) renderAll(lastSnapshot);

        // Reload METAR history for new station
        fetchMetarHistory();
    }

    // === SSE Connection ===
    function connectSSE() {
        const sseDot = document.getElementById('sse-dot');
        const sseLabel = document.getElementById('sse-label');

        evtSource = new EventSource('/api/v2/world/stream');

        evtSource.addEventListener('snapshot', (e) => {
            try {
                lastSnapshot = JSON.parse(e.data);
                renderAll(lastSnapshot);
            } catch(err) { console.error('SSE snapshot parse error:', err); }
        });

        evtSource.addEventListener('update', (e) => {
            try {
                const event = JSON.parse(e.data);
                if (lastSnapshot) {
                    applySSEUpdate(event);
                } else {
                    fetchSnapshot();
                }
            } catch(err) {
                console.error('SSE update parse error:', err);
                fetchSnapshot();
            }
        });

        evtSource.onopen = () => {
            sseConnected = true;
            sseDot.classList.add('connected');
            sseLabel.textContent = 'SSE Live';
            document.getElementById('system-status-text').textContent = 'Connected';
        };

        evtSource.onerror = () => {
            sseConnected = false;
            sseDot.classList.remove('connected');
            sseLabel.textContent = 'SSE Reconnecting...';
            document.getElementById('system-status-text').textContent = 'Reconnecting...';
        };
    }

    function applySSEUpdate(event) {
        if (event.type === 'official' && event.data) {
            const sid = event.data.station_id;
            if (!lastSnapshot.official) lastSnapshot.official = {};
            lastSnapshot.official[sid] = event.data;
            renderMetar(lastSnapshot.official);
        } else if (event.type === 'aux' && event.data) {
            const sid = event.data.station_id;
            if (!lastSnapshot.aux) lastSnapshot.aux = {};
            lastSnapshot.aux[sid] = event.data;
            renderAux(lastSnapshot.aux);
            renderPWS(lastSnapshot.aux, lastSnapshot.pws_details, lastSnapshot.official, lastSnapshot.pws_metrics);
        } else if (event.type === 'env' && event.data) {
            const feat = event.data.feature_type;
            if (!lastSnapshot.env) lastSnapshot.env = {};
            lastSnapshot.env[feat] = event.data;
            renderEnv(lastSnapshot.env);
        } else {
            fetchSnapshot();
        }
    }

    // === Fallback polling ===
    async function fetchSnapshot() {
        try {
            const resp = await fetch('/api/v2/world/snapshot', { cache: 'no-store' });
            const raw = await resp.text();

            // Skip re-render if data hasn't changed
            const hash = raw.length + ':' + raw.substring(0, 200);
            if (hash === lastSnapshotHash) return;
            lastSnapshotHash = hash;

            const data = JSON.parse(raw);
            lastSnapshot = data;
            renderAll(data);
        } catch(err) {
            console.error('Snapshot fetch error:', err);
        }
    }

    // === Render Functions ===
    function renderAll(snap) {
        renderSystemBar(snap);
        renderMetar(snap.official);
        renderAux(snap.aux);
        renderPWS(snap.aux, snap.pws_details, snap.official, snap.pws_metrics);
        renderEnv(snap.env);
        renderQC(snap.qc);
        renderHealth(snap.health, snap.tape_size);
    }

    function renderSystemBar(snap) {
        const el = (id) => document.getElementById(id);
        // Use dynamic timezone formatters instead of backend-provided NYC time
        if (snap.ts_utc) {
            const d = new Date(snap.ts_utc);
            el('ts-local').textContent = formatTimeInTz(snap.ts_utc, localTimeFormatter);
            el('ts-madrid').textContent = formatTimeInTz(snap.ts_utc, esTimeFormatter);
            el('ts-utc').textContent = d.toISOString().substring(11, 19) + ' UTC';
        }
    }

    function renderMetar(official) {
        if (!official || Object.keys(official).length === 0) return;

        // Show selected station's data
        const obs = official[currentStation];
        if (!obs) {
            // No data for selected station - show message
            const el = (id) => document.getElementById(id);
            el('metar-temp').textContent = '--';
            el('metar-station').textContent = currentStation;
            el('metar-source').textContent = 'No data';
            el('metar-age').textContent = '--';
            const badge = el('metar-badge');
            badge.textContent = 'NO DATA';
            badge.className = 'panel-badge badge-no-data';
            // Clear extra stations
            const extraDiv = document.getElementById('metar-extra-stations');
            if (extraDiv) extraDiv.innerHTML = '';
            return;
        }

        const el = (id) => document.getElementById(id);

        // Display in station market units (F for US, C for London/Ankara).
        const displayTempF = obs.temp_f_raw != null ? Number(obs.temp_f_raw) : Number(obs.temp_f);
        const displayTemp = convertTempFromF(displayTempF);
        el('metar-temp').textContent = Number.isFinite(displayTemp) ? displayTemp.toFixed(1) : '--';
        el('metar-station').textContent = obs.station_id || '--';
        el('metar-source').textContent = obs.source || '--';
        el('metar-age').textContent = obs.source_age_s != null ? formatAge(obs.source_age_s) : '--';

        // Store obs time for live age ticker
        if (obs.obs_time_utc) {
            metarObsTimeUtc = new Date(obs.obs_time_utc);
            updateMetarLiveAge();
        }
        el('metar-temp-c').textContent = obs.temp_c != null ? obs.temp_c.toFixed(1) + ' C' : '--';
        if (usesCelsius()) {
            const settlementC = Number(obs.temp_c);
            el('metar-settlement').textContent = Number.isFinite(settlementC) ? `${Math.round(settlementC)}°C` : '--';
        } else {
            const settlementF = Number(obs.temp_f);
            el('metar-settlement').textContent = Number.isFinite(settlementF) ? `${settlementF.toFixed(0)}°F` : '--';
        }
        el('metar-dewpoint').textContent = obs.dewpoint_c != null ? obs.dewpoint_c.toFixed(1) + ' C' : '--';
        el('metar-wind').textContent = (obs.wind_dir != null && obs.wind_speed != null)
            ? obs.wind_dir + '@ ' + obs.wind_speed + 'kt'
            : '--';
        el('metar-sky').textContent = obs.sky_condition || '--';

        // QC
        if (obs.qc_passed === true) {
            el('metar-qc').textContent = 'PASS';
            el('metar-qc').style.color = '#10B981';
        } else if (obs.qc_passed === false) {
            el('metar-qc').textContent = 'FAIL';
            el('metar-qc').style.color = '#EF4444';
        } else {
            el('metar-qc').textContent = '--';
        }

        // QC Flags shown on panel
        if (obs.qc_flags && obs.qc_flags.length > 0) {
            el('metar-qc').textContent += ' (' + obs.qc_flags.join(', ') + ')';
        }

        // Daily Max - populated by fetchMetarHistory() from NOAA (full day source of truth)
        // WorldState daily_max is only a fallback until history loads
        const dmRow = el('daily-max-row');
        if (dmRow.style.display === 'none' && obs.daily_max_f != null) {
            // Show WorldState value as temporary until NOAA history overwrites it
            dmRow.style.display = 'flex';
            el('daily-max-temp').textContent = formatTempFromF(obs.daily_max_f, 0);
            el('daily-max-raw').textContent = 'Raw: ' + formatTempFromF(obs.daily_max_f_raw, 1);
            el('daily-max-time').textContent = obs.daily_max_obs_utc
                ? 'at ' + formatTimeInTz(obs.daily_max_obs_utc, localTimeFormatter) + ' ' + localTzLabel
                : '';
        }

        // Timestamps - use dynamic timezone formatters
        el('metar-obs-utc').textContent = obs.obs_time_utc ? obs.obs_time_utc.substring(0, 19) : '--';
        el('metar-obs-local').textContent = formatTimeInTz(obs.obs_time_utc, localTimeFormatter);
        el('metar-obs-mad').textContent = formatTimeInTz(obs.obs_time_utc, esTimeFormatter);

        // Badge
        const badge = el('metar-badge');
        badge.textContent = 'LIVE';
        badge.className = 'panel-badge badge-live';

        // Clear extra stations div (no longer showing mixed stations)
        let extraDiv = document.getElementById('metar-extra-stations');
        if (extraDiv) extraDiv.innerHTML = '';
    }

    function renderAux(aux) {
        const container = document.getElementById('aux-content');
        const badge = document.getElementById('aux-badge');

        if (!aux || Object.keys(aux).length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No auxiliary observations yet. Upstream data appears after METAR fetch with valid wind data.</p>';
            badge.textContent = 'NO DATA';
            badge.className = 'panel-badge badge-no-data';
            return;
        }

        // Filter aux entries: exclude PWS clusters, and only show entries associated with current station
        // Aux station_ids are like "UPSTREAM_KLGA_xxx" - filter by currentStation in the key
        const stationLower = currentStation.toLowerCase();
        const filtered = Object.entries(aux).filter(([sid]) => {
            if (sid.startsWith('PWS_')) return false;  // PWS shown in separate panel
            // Match aux entries containing the station ID
            return sid.toLowerCase().includes(stationLower) || sid.includes(currentStation);
        });

        if (filtered.length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No auxiliary observations for ' + currentStation + '.</p>';
            badge.textContent = 'NO DATA';
            badge.className = 'panel-badge badge-no-data';
            return;
        }

        badge.textContent = 'ACTIVE';
        badge.className = 'panel-badge badge-ok';

        let html = '';
        for (const [sid, a] of filtered) {
            const driftClass = a.drift > 0.5 ? 'positive' : (a.drift < -0.5 ? 'negative' : 'neutral');
            const driftSign = a.drift > 0 ? '+' : '';
            html += `
                <div class="aux-card">
                    <div>
                        <div class="aux-id">${sid}</div>
                        <div style="font-size:11px; color: var(--text-muted);">
                            ${a.source} | Age: ${formatAge(a.source_age_s)}
                            ${a.support > 1 ? ' | Support: ' + a.support : ''}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="aux-temp">${formatTempFromF(a.temp_f, 1)}</div>
                        <div class="aux-drift ${driftClass}">Drift: ${driftSign}${a.drift.toFixed(2)} C</div>
                    </div>
                </div>`;
        }
        container.innerHTML = html;
    }

    // PWS table state for sorting and expand/collapse
    let pwsTableData = {};
    let pwsSortState = { column: 'distance_km', direction: 'asc' };
    let pwsExpandedState = {}; // Track expanded state per station
    let pwsSourceFilters = { SYNOPTIC: true, MADIS: true, OPEN_METEO: true, WUNDERGROUND: true };

    function normalizeSource(src) {
        return String(src || '').trim().toUpperCase().replace(/-/g, '_');
    }

    function sourceLabel(src) {
        const norm = normalizeSource(src);
        if (!norm) return 'Unknown';
        if (norm === 'SYNOPTIC') return 'Synoptic';
        if (norm === 'OPEN_METEO') return 'Open-Meteo';
        if (norm === 'WUNDERGROUND') return 'Wunderground';
        if (norm.startsWith('MADIS_')) {
            const provider = norm.replace('MADIS_', '');
            if (provider === 'APRSWXNET') return 'MADIS CWOP';
            if (provider === 'MesoWest') return 'MADIS MesoWest';
            return `MADIS ${provider}`;
        }
        return norm;
    }

    function sourceGroup(src) {
        const norm = normalizeSource(src);
        if (norm === 'SYNOPTIC') return 'SYNOPTIC';
        if (norm === 'OPEN_METEO') return 'OPEN_METEO';
        if (norm === 'WUNDERGROUND') return 'WUNDERGROUND';
        if (norm.startsWith('MADIS_')) return 'MADIS';
        return 'OTHER';
    }

    function sourceEnabled(src) {
        const g = sourceGroup(src);
        if (g === 'OTHER') return true;
        return !!pwsSourceFilters[g];
    }

    function median(values) {
        if (!values || values.length === 0) return null;
        const sorted = [...values].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        if (sorted.length % 2) return sorted[mid];
        return (sorted[mid - 1] + sorted[mid]) / 2;
    }

    function mean(values) {
        if (!values || values.length === 0) return null;
        return values.reduce((acc, v) => acc + v, 0) / values.length;
    }

    function computeFilteredPWSStats(details, officialTempC) {
        const valid = details.filter(d => d.valid);
        if (valid.length === 0) {
            return {
                median_c: null,
                median_f: null,
                mean_c: null,
                mean_f: null,
                support: 0,
                drift_c: null,
                source_age_s: null,
            };
        }

        const tempsC = valid.map(d => Number(d.temp_c)).filter(Number.isFinite);
        const medC = median(tempsC);
        const avgC = mean(tempsC);
        const medF = medC == null ? null : ((medC * 9 / 5) + 32);
        const avgF = avgC == null ? null : ((avgC * 9 / 5) + 32);
        const minAgeMinutes = Math.min(...valid.map(d => Number(d.age_minutes ?? Infinity)));
        const ageSeconds = Number.isFinite(minAgeMinutes) ? minAgeMinutes * 60 : null;

        return {
            median_c: medC,
            median_f: medF,
            mean_c: avgC,
            mean_f: avgF,
            support: valid.length,
            drift_c: (officialTempC != null && medC != null) ? (medC - officialTempC) : null,
            source_age_s: ageSeconds,
        };
    }

    function renderPWSFilters(rawDetails) {
        const filtersEl = document.getElementById('pws-filters');
        if (!filtersEl) return;

        const counts = { SYNOPTIC: 0, MADIS: 0, OPEN_METEO: 0, WUNDERGROUND: 0 };
        for (const r of rawDetails || []) {
            const g = sourceGroup(r.source);
            if (counts[g] != null) counts[g] += 1;
        }

        const chips = [
            { key: 'SYNOPTIC', label: `Synoptic (${counts.SYNOPTIC})` },
            { key: 'MADIS', label: `MADIS (${counts.MADIS})` },
            { key: 'OPEN_METEO', label: `Open-Meteo (${counts.OPEN_METEO})` },
            { key: 'WUNDERGROUND', label: `Wunderground (${counts.WUNDERGROUND})` },
        ];

        filtersEl.innerHTML = chips.map(c => {
            const active = pwsSourceFilters[c.key] ? 'active' : '';
            return `<button class="pws-filter-chip ${active}" onclick="togglePWSFilter('${c.key}')">${c.label}</button>`;
        }).join('') + '<span class="pws-filter-help">Filtros activos recalculan metricas y tabla.</span>';
    }

    window.togglePWSFilter = function(key) {
        if (!(key in pwsSourceFilters)) return;
        pwsSourceFilters[key] = !pwsSourceFilters[key];

        // Keep at least one source active.
        if (!Object.values(pwsSourceFilters).some(Boolean)) {
            pwsSourceFilters[key] = true;
        }

        lastPWSFingerprint = '';
        if (lastSnapshot) renderAll(lastSnapshot);
    };

    function sortPWSData(data, column, direction) {
        return [...data].sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            // Handle null/undefined
            if (valA == null) valA = direction === 'asc' ? Infinity : -Infinity;
            if (valB == null) valB = direction === 'asc' ? Infinity : -Infinity;
            // For strings (timestamps), compare as strings
            if (typeof valA === 'string') {
                return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
            // For numbers
            return direction === 'asc' ? valA - valB : valB - valA;
        });
    }

    // Toggle expand/collapse for PWS table
    window.togglePWSExpand = function(stationName) {
        pwsExpandedState[stationName] = !pwsExpandedState[stationName];
        const tableContainer = document.getElementById('pws-table-' + stationName);
        if (tableContainer && pwsTableData[stationName]) {
            tableContainer.innerHTML = renderPWSTable(stationName, pwsTableData[stationName]);
        }
    };

    function renderPWSTable(stationName, details) {
        const sorted = sortPWSData(details, pwsSortState.column, pwsSortState.direction);
        const arrow = pwsSortState.direction === 'asc' ? ' ▲' : ' ▼';
        const isExpanded = pwsExpandedState[stationName] || false;

        const getSortClass = (col) => pwsSortState.column === col ? 'pws-sort-active' : '';
        const getSortArrow = (col) => pwsSortState.column === col ? arrow : '';

        const sourceCounts = {};
        for (const d of details) {
            const src = d.source || 'UNKNOWN';
            sourceCounts[src] = (sourceCounts[src] || 0) + 1;
        }
        const sourceInfo = Object.entries(sourceCounts)
            .sort((a, b) => b[1] - a[1])
            .map(([src, count]) => `${count} ${sourceLabel(src)}`)
            .join(' + ');

        const expandIcon = isExpanded ? '▼' : '▶';
        const expandText = isExpanded ? 'Collapse' : 'Expand';

        let html = `
            <div style="margin-top:12px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                    <div style="font-size:12px; color:var(--text-muted); font-weight:600;">
                        Individual Stations (${details.length}: ${sourceInfo})
                    </div>
                    <button onclick="togglePWSExpand('${stationName}')"
                        style="background:rgba(139,92,246,0.15); border:1px solid rgba(139,92,246,0.3); color:#8B5CF6; padding:4px 12px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px;">
                        <span>${expandIcon}</span> ${expandText} (${details.length})
                    </button>
                </div>`;

        if (!isExpanded) {
            // Show summary only when collapsed
            const validCount = details.filter(d => d.valid).length;
            const temps = details
                .filter(d => d.valid)
                .map(d => convertTempFromF(d.temp_f))
                .filter(Number.isFinite);
            const minTemp = temps.length > 0 ? `${Math.min(...temps).toFixed(1)}${tempUnitSymbol()}` : '--';
            const maxTemp = temps.length > 0 ? `${Math.max(...temps).toFixed(1)}${tempUnitSymbol()}` : '--';
            html += `
                <div style="font-size:11px; color:var(--text-muted); padding:8px 12px; background:rgba(255,255,255,0.02); border-radius:6px;">
                    ${validCount} valid stations | Temp range: <span style="color:#8B5CF6; font-weight:600;">${minTemp} - ${maxTemp}</span>
                    | Click expand to see all stations
                </div>
            </div>`;
            return html;
        }

        // Show full table when expanded
        html += `
                <div style="font-size:10px; color:var(--text-muted); margin-bottom:6px;">Click column headers to sort</div>
                <div style="overflow-x:auto; max-height:400px; overflow-y:auto;">
                <table style="width:100%; font-size:10px; border-collapse:collapse; min-width:1240px;">
                    <thead style="position:sticky; top:0; background:var(--bg-primary); z-index:1;">
                        <tr style="color:var(--text-muted); text-align:left; border-bottom:1px solid rgba(255,255,255,0.1);">
                            <th style="padding:6px 4px;">Station</th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'source')" class="${getSortClass('source')}">
                                Source${getSortArrow('source')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'distance_km')" class="${getSortClass('distance_km')}">
                                Dist${getSortArrow('distance_km')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'temp_f')" class="${getSortClass('temp_f')}">
                                Temp${tempUnitSymbol()}${getSortArrow('temp_f')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'learning_weight')" class="${getSortClass('learning_weight')}">
                                Weight${getSortArrow('learning_weight')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'learning_now_score')" class="${getSortClass('learning_now_score')}">
                                Now${getSortArrow('learning_now_score')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'learning_lead_score')" class="${getSortClass('learning_lead_score')}">
                                Lead${getSortArrow('learning_lead_score')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'learning_now_samples')" class="${getSortClass('learning_now_samples')}">
                                N now${getSortArrow('learning_now_samples')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'learning_lead_samples')" class="${getSortClass('learning_lead_samples')}">
                                N lead${getSortArrow('learning_lead_samples')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'obs_time_nyc')" class="${getSortClass('obs_time_nyc')}">
                                ${localTzLabel} Time${getSortArrow('obs_time_nyc')}
                            </th>
                            <th style="padding:6px 4px; cursor:pointer; user-select:none;" onclick="sortPWSColumn('${stationName}', 'obs_time_madrid')" class="${getSortClass('obs_time_madrid')}">
                                ES Time${getSortArrow('obs_time_madrid')}
                            </th>
                            <th style="padding:6px 4px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>`;

        for (const r of sorted) {
            const rowStyle = r.valid ? '' : 'opacity:0.5; text-decoration:line-through;';
            const statusColor = r.valid ? '#10B981' : '#EF4444';
            const statusText = r.valid ? 'OK' : (r.qc_flag || 'EXCLUDED');
            // Use dynamic timezone formatters for local time
            const localTime = formatTimeInTz(r.obs_time_utc, localTimeFormatter);
            const madTime = formatTimeInTz(r.obs_time_utc, esTimeFormatter);
            const nycDate = r.obs_time_nyc ? r.obs_time_nyc.substring(5, 10) : '';
            const madDate = r.obs_time_madrid ? r.obs_time_madrid.substring(5, 10) : '';
            const primaryTemp = formatTempFromF(r.temp_f, 1);
            const secondaryTemp = usesCelsius()
                ? (Number.isFinite(Number(r.temp_f)) ? `${Number(r.temp_f).toFixed(1)}°F` : '--')
                : (Number.isFinite(Number(r.temp_c)) ? `${Number(r.temp_c).toFixed(1)}°C` : '--');


            const weightVal = numericOrNaN(r.learning_weight);
            const nowScore = numericOrNaN(r.learning_now_score);
            const leadScore = numericOrNaN(r.learning_lead_score);
            const nowSamples = numericOrNaN(r.learning_now_samples);
            const leadSamples = numericOrNaN(r.learning_lead_samples);
            const qualityBand = String(r.learning_quality_band || 'INIT');
            const learningPhase = String(r.learning_phase || (r.learning_rank_eligible ? 'READY' : 'WARMUP')).toUpperCase();

            const scoreColor = (score) => {
                if (!Number.isFinite(score)) return 'var(--text-muted)';
                if (score >= 85) return '#10B981';
                if (score >= 70) return '#22C55E';
                if (score >= 55) return '#F4D03F';
                if (score >= 40) return '#F97316';
                return '#EF4444';
            };

            // Source badge metadata
            let sourceColor = '#6B7280';
            let sourceBadge = r.source || 'UNK';
            let sourceTitle = sourceLabel(r.source);
            const srcNorm = normalizeSource(r.source);

            if (srcNorm === 'SYNOPTIC') {
                sourceColor = '#10B981';
                sourceBadge = 'SYN';
                sourceTitle = 'Synoptic Data (Real PWS)';
            } else if (srcNorm === 'OPEN_METEO') {
                sourceColor = '#F59E0B';
                sourceBadge = 'OM';
                sourceTitle = 'Open-Meteo (Grid Point)';
            } else if (srcNorm === 'WUNDERGROUND') {
                sourceColor = '#F97316';
                sourceBadge = 'WU';
                sourceTitle = 'Wunderground PWS';
            } else if (srcNorm.startsWith('MADIS_APRSWXNET')) {
                sourceColor = '#22C55E';
                sourceBadge = 'CWOP';
                sourceTitle = 'MADIS / CWOP (APRSWXNET)';
            } else if (srcNorm.startsWith('MADIS_')) {
                sourceColor = '#06B6D4';
                sourceBadge = 'MADIS';
                sourceTitle = sourceLabel(r.source);
            }

            html += `
                <tr style="${rowStyle}">
                    <td style="padding:5px 4px;">
                        <div style="font-family:'JetBrains Mono',monospace; font-weight:600; font-size:10px;">${r.station_id}</div>
                        <div style="font-size:9px; color:var(--text-muted); max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${r.station_name}">${r.station_name || ''}</div>
                    </td>
                    <td style="padding:5px 4px;">
                        <span style="font-size:9px; padding:2px 6px; border-radius:4px; background:${sourceColor}20; color:${sourceColor}; font-weight:600;" title="${sourceTitle}">${sourceBadge}</span>
                    </td>
                    <td style="padding:5px 4px; font-weight:500;">${r.distance_km.toFixed(1)}km</td>
                    <td style="padding:5px 4px; font-weight:600; color:#8B5CF6;">${primaryTemp} <span style="color:var(--text-muted); font-size:9px;">(${secondaryTemp})</span></td>
                    <td style="padding:5px 4px; font-family:'JetBrains Mono',monospace;">
                        ${Number.isFinite(weightVal) ? weightVal.toFixed(2) : '--'}
                        <div style="font-size:8px; color:var(--text-muted);">${qualityBand} | ${learningPhase}</div>
                    </td>
                    <td style="padding:5px 4px; color:${scoreColor(nowScore)}; font-family:'JetBrains Mono',monospace;">${Number.isFinite(nowScore) ? nowScore.toFixed(0) : '--'}</td>
                    <td style="padding:5px 4px; color:${scoreColor(leadScore)}; font-family:'JetBrains Mono',monospace;">${Number.isFinite(leadScore) ? leadScore.toFixed(0) : '--'}</td>
                    <td style="padding:5px 4px; font-family:'JetBrains Mono',monospace;">${Number.isFinite(nowSamples) ? nowSamples : '--'}</td>
                    <td style="padding:5px 4px; font-family:'JetBrains Mono',monospace;">${Number.isFinite(leadSamples) ? leadSamples : '--'}</td>
                    <td style="padding:5px 4px; font-family:'JetBrains Mono',monospace;">
                        <div style="color:#3B82F6;">${localTime}</div>
                        <div style="font-size:8px; color:var(--text-muted);">${nycDate}</div>
                    </td>
                    <td style="padding:5px 4px; font-family:'JetBrains Mono',monospace;">
                        <div style="color:#F59E0B;">${madTime}</div>
                        <div style="font-size:8px; color:var(--text-muted);">${madDate}</div>
                    </td>
                    <td style="padding:5px 4px; color:${statusColor}; font-size:9px;">${statusText}</td>
                </tr>`;
        }

        html += `</tbody></table></div></div>`;
        return html;
    }

    // Global function for sorting (called from onclick)
    window.sortPWSColumn = function(stationName, column) {
        if (pwsSortState.column === column) {
            pwsSortState.direction = pwsSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            pwsSortState.column = column;
            pwsSortState.direction = 'asc';
        }
        // Re-render just the table
        const tableContainer = document.getElementById('pws-table-' + stationName);
        if (tableContainer && pwsTableData[stationName]) {
            tableContainer.innerHTML = renderPWSTable(stationName, pwsTableData[stationName]);
        }
    };

    let lastPWSFingerprint = '';

    function renderPWS(aux, pwsDetails, official, pwsMetrics) {
        const container = document.getElementById('pws-content');
        const badge = document.getElementById('pws-badge');
        const filtersEl = document.getElementById('pws-filters');

        if (!aux) {
            return;
        }

        // Find PWS entries for the current station (e.g., "PWS_KLGA")
        const pwsEntries = Object.entries(aux).filter(([sid]) =>
            sid === 'PWS_' + currentStation
        );

        const stationName = currentStation;
        const rawDetails = pwsDetails && pwsDetails[stationName] ? pwsDetails[stationName] : [];
        renderPWSFilters(rawDetails);

        if (pwsEntries.length === 0) {
            if (filtersEl) {
                filtersEl.innerHTML = '';
            }
            if (badge.textContent !== 'NO DATA') {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No PWS cluster data for ' + currentStation + ' yet.</p>';
                badge.textContent = 'NO DATA';
                badge.className = 'panel-badge badge-no-data';
            }
            return;
        }

        // Build fingerprint from consensus values to skip re-render if unchanged
        const p = pwsEntries[0][1];
        const metricSig = JSON.stringify((pwsMetrics && pwsMetrics[stationName]) ? pwsMetrics[stationName] : {});
        const detailSig = (rawDetails || []).map(r => {
            const tempC = Number(r.temp_c);
            const tempSig = Number.isFinite(tempC) ? tempC.toFixed(1) : '--';
            const wSig = Number.isFinite(numericOrNaN(r.learning_weight)) ? numericOrNaN(r.learning_weight).toFixed(2) : '--';
            const nSig = Number.isFinite(numericOrNaN(r.learning_now_score)) ? numericOrNaN(r.learning_now_score).toFixed(0) : '--';
            const lSig = Number.isFinite(numericOrNaN(r.learning_lead_score)) ? numericOrNaN(r.learning_lead_score).toFixed(0) : '--';
            return `${r.station_id || ''}|${normalizeSource(r.source)}|${r.valid ? 1 : 0}|${r.qc_flag || ''}|${tempSig}|${r.obs_time_utc || ''}|${wSig}|${nSig}|${lSig}`;
        }).join(';');
        const fp = `${currentStation}:${p.temp_f}:${p.support}:${p.drift}:${detailSig}:${JSON.stringify(pwsSourceFilters)}:${metricSig}`;
        if (fp === lastPWSFingerprint) return;  // Skip re-render
        lastPWSFingerprint = fp;

        badge.textContent = 'ACTIVE';
        badge.className = 'panel-badge badge-ok';

        let html = '';
        for (const [, pEntry] of pwsEntries) {
            const filteredDetails = rawDetails.filter(r => sourceEnabled(r.source));
            const officialTempC = official && official[stationName] && official[stationName].temp_c != null
                ? Number(official[stationName].temp_c)
                : null;
            const stats = computeFilteredPWSStats(filteredDetails, officialTempC);

            const driftVal = stats.drift_c != null ? stats.drift_c : pEntry.drift;
            const driftClass = driftVal > 0.5 ? 'positive' : (driftVal < -0.5 ? 'negative' : 'neutral');
            const driftSign = driftVal > 0 ? '+' : '';

            // Main headline: weighted consensus actually used by prediction.
            const headerTempF = Number.isFinite(Number(pEntry.temp_f))
                ? Number(pEntry.temp_f)
                : (stats.mean_f != null ? stats.mean_f : (stats.median_f != null ? stats.median_f : null));
            const headerTempDisplay = convertTempFromF(headerTempF);
            const headerMedianC = stats.median_c;
            const headerMeanC = stats.mean_c;
            const headerSupport = stats.support;
            const headerAge = stats.source_age_s != null ? stats.source_age_s : pEntry.source_age_s;
            const learningMetric = (pwsMetrics && pwsMetrics[stationName] && pwsMetrics[stationName].learning)
                ? pwsMetrics[stationName].learning
                : {};
            const topProfilesAll = Array.isArray(learningMetric.top_profiles) ? learningMetric.top_profiles : [];
            const topProfilesRank = Array.isArray(learningMetric.rank_top_profiles)
                ? learningMetric.rank_top_profiles
                : topProfilesAll.filter(row => row && row.rank_eligible === true);
            const topProfile = topProfilesRank.length > 0 ? topProfilesRank[0] : null;
            const weightedSupport = Number.isFinite(Number(pEntry.weighted_support))
                ? Number(pEntry.weighted_support)
                : Number(learningMetric.weighted_support);
            const topNowScore = topProfile ? numericOrNaN(topProfile.now_score) : NaN;
            const topLeadScore = topProfile ? numericOrNaN(topProfile.lead_score) : NaN;
            const topWeight = topProfile ? numericOrNaN(topProfile.weight) : NaN;
            const rankReadyCount = numericOrNaN(learningMetric.rank_ready_station_count);
            const trackedCount = numericOrNaN(learningMetric.tracked_station_count);
            const policy = learningMetric && typeof learningMetric.policy === 'object'
                ? learningMetric.policy
                : {};
            const rankMinNow = Number.isFinite(numericOrNaN(policy.rank_min_now_samples))
                ? Number(policy.rank_min_now_samples)
                : 2;
            const rankMinLead = Number.isFinite(numericOrNaN(policy.rank_min_lead_samples))
                ? Number(policy.rank_min_lead_samples)
                : 1;
            const rankingStatus = String(learningMetric.ranking_status || (topProfile ? 'READY' : 'WARMUP')).toUpperCase();
            const warmupReason = String(learningMetric.warmup_reason || '').trim();
            const statusColor = rankingStatus === 'READY' ? '#10B981' : '#F59E0B';
            const rankingStatusText = rankingStatus === 'READY'
                ? `READY (${Number.isFinite(rankReadyCount) ? rankReadyCount : topProfilesRank.length}/${Number.isFinite(trackedCount) ? trackedCount : topProfilesAll.length} stations)`
                : 'WARMUP';
            const rankingRuleShort = `Ranking visible when now>=${rankMinNow} and lead>=${rankMinLead}`;
            const rankingStatusNote = rankingStatus === 'READY'
                ? rankingRuleShort
                : (warmupReason || rankingRuleShort);
            const nowColor = Number.isFinite(topNowScore)
                ? (topNowScore >= 85 ? '#10B981' : topNowScore >= 70 ? '#22C55E' : topNowScore >= 55 ? '#F4D03F' : topNowScore >= 40 ? '#F97316' : '#EF4444')
                : 'var(--text-muted)';
            const leadColor = Number.isFinite(topLeadScore)
                ? (topLeadScore >= 85 ? '#10B981' : topLeadScore >= 70 ? '#22C55E' : topLeadScore >= 55 ? '#F4D03F' : topLeadScore >= 40 ? '#F97316' : '#EF4444')
                : 'var(--text-muted)';

            html += `
                <div style="margin-bottom: 16px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                        <div>
                            <span style="font-weight:700; font-size:15px; font-family:'JetBrains Mono',monospace;">${stationName}</span>
                            <span style="font-size:11px; color:var(--text-muted); margin-left:8px;">Weighted Consensus (prediction input)</span>
                        </div>
                        <div style="text-align:right;">
                            <span style="font-size:28px; font-weight:700; font-family:'Space Grotesk',sans-serif; color: #8B5CF6;">
                                ${headerTempDisplay != null ? headerTempDisplay.toFixed(1) : '--'}
                            </span>
                            <span style="font-size:14px; color:var(--text-secondary);">${usesCelsius() ? 'C' : 'F'}</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:10px;">
                        <div class="detail-item">
                            <span class="detail-label">Median C (filtro)</span>
                            <span class="detail-value">${headerMedianC != null ? headerMedianC.toFixed(2) : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Media C (filtro)</span>
                            <span class="detail-value">${headerMeanC != null ? headerMeanC.toFixed(2) : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Support (filtro)</span>
                            <span class="detail-value">${headerSupport || 0} stations</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Drift vs METAR</span>
                            <span class="detail-value aux-drift ${driftClass}">${driftVal != null ? `${driftSign}${driftVal.toFixed(2)} C` : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Source Age</span>
                            <span class="detail-value">${formatAge(headerAge)}</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap:12px; margin-bottom:10px; padding:10px; border:1px solid rgba(59,130,246,0.25); background:rgba(59,130,246,0.06); border-radius:10px;">
                        <div class="detail-item">
                            <span class="detail-label" title="Peso usado en el consenso actual de temperatura (no es ranking predictivo de largo plazo).">Learning Weight (Now)</span>
                            <span class="detail-value">${Number.isFinite(topWeight) ? topWeight.toFixed(2) : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Top Station</span>
                            <span class="detail-value">${topProfile && topProfile.station_id ? topProfile.station_id : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label" title="Score de acierto contra METAR en observaciones alineadas en tiempo.">Top Now Score</span>
                            <span class="detail-value" style="color:${nowColor};">${Number.isFinite(topNowScore) ? topNowScore.toFixed(0) : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label" title="Score de acierto 35-85 minutos antes del METAR oficial (capacidad de anticipacion).">Top Lead Score</span>
                            <span class="detail-value" style="color:${leadColor};">${Number.isFinite(topLeadScore) ? topLeadScore.toFixed(0) : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label" title="Suma de pesos de las estaciones validas usadas en el consenso de este tick.">Weighted Support</span>
                            <span class="detail-value">${Number.isFinite(weightedSupport) ? weightedSupport.toFixed(2) : '--'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Learning Status</span>
                            <span class="detail-value" style="color:${statusColor};">${rankingStatusText}</span>
                        </div>
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <span class="detail-label">Rule</span>
                            <span class="detail-value" style="font-size:11px; line-height:1.3;">
                                Now score = error alignado con METAR. Lead score = acierto 35-85 min antes.
                                ${rankingStatusNote}
                            </span>
                        </div>
                    </div>
                    `;

            if (filteredDetails.length > 0) {
                pwsTableData[stationName] = filteredDetails;
                html += `<div id="pws-table-${stationName}">${renderPWSTable(stationName, filteredDetails)}</div>`;
            } else {
                html += '<p style="color: var(--text-muted); font-size: 13px;">No hay estaciones para los filtros seleccionados.</p>';
            }

            html += `</div>`;
        }
        container.innerHTML = html;
    }

    function renderEnv(env) {
        if (!env) return;

        // SST
        if (env.SST) {
            const sst = env.SST;
            document.getElementById('env-sst-value').textContent = sst.value != null ? sst.value.toFixed(1) + ' ' + sst.unit : '--';
            document.getElementById('env-sst-source').textContent = 'Source: ' + (sst.source || '--');
            document.getElementById('env-sst-age').textContent = 'Age: ' + formatAge(sst.source_age_s);
            document.getElementById('env-sst-location').textContent = 'Ref: ' + (sst.location_ref || '--');
            // Use dynamic timezone formatters
            document.getElementById('env-ts-local').textContent = formatTimeInTz(sst.obs_time_utc, localTimeFormatter);
            document.getElementById('env-ts-mad').textContent = formatTimeInTz(sst.obs_time_utc, esTimeFormatter);
        }

        // AOD
        if (env.AOD) {
            const aod = env.AOD;
            const val = aod.value != null ? aod.value.toFixed(3) : '--';
            document.getElementById('env-aod-value').textContent = val;
            document.getElementById('env-aod-source').textContent = 'Source: ' + (aod.source || '--');
            document.getElementById('env-aod-age').textContent = 'Age: ' + formatAge(aod.source_age_s);
            document.getElementById('env-aod-location').textContent = 'Ref: ' + (aod.location_ref || '--');

            // Color code AOD
            const aodEl = document.getElementById('env-aod-value');
            if (aod.value > 0.5) {
                aodEl.style.color = '#EF4444'; // Heavy
            } else if (aod.value > 0.3) {
                aodEl.style.color = '#F4D03F'; // Moderate
            } else {
                aodEl.style.color = '#10B981'; // Clear
            }
        }
    }

    function renderQC(qc) {
        const container = document.getElementById('qc-content');
        if (!qc || Object.keys(qc).length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No QC data yet. Data appears after first METAR observation.</p>';
            return;
        }

        // Filter QC data for current station
        const filtered = Object.entries(qc).filter(([sid]) => sid === currentStation);

        if (filtered.length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No QC data for ' + currentStation + '.</p>';
            return;
        }

        let html = '';
        for (const [sid, q] of filtered) {
            const dotClass = q.status.toLowerCase();
            const flagsHtml = (q.flags || []).map(f => `<span class="qc-flag">${f}</span>`).join('');
            html += `
                <div class="qc-station">
                    <div>
                        <span class="qc-station-id">${sid}</span>
                        ${flagsHtml ? '<div class="qc-flags" style="margin-top:4px;">' + flagsHtml + '</div>' : ''}
                    </div>
                    <div class="qc-status">
                        <span style="font-size:12px; color: var(--text-secondary);">${q.status}</span>
                        <span class="qc-dot ${dotClass}"></span>
                    </div>
                </div>`;
        }
        container.innerHTML = html;
    }

    function renderHealth(health, tapeSize) {
        const tbody = document.getElementById('health-tbody');
        const tapeEl = document.getElementById('health-tape-count');

        if (tapeSize != null) {
            tapeEl.textContent = `Tape: ${tapeSize} events`;
        }

        if (!health || Object.keys(health).length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="color: var(--text-muted); text-align:center;">No sources registered yet.</td></tr>';
            return;
        }

        // Filter health entries for current station
        const stationUpper = currentStation.toUpperCase();
        const filtered = Object.entries(health).filter(([key, h]) => {
            const src = (h.source || key).toUpperCase();
            return src.includes(stationUpper);
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="color: var(--text-muted); text-align:center;">No health data for ' + currentStation + '.</td></tr>';
            return;
        }

        let html = '';
        const statusOrder = { 'DEAD': 0, 'STALE': 1, 'NO_DATA': 2, 'OK': 3, 'LIVE': 4 };
        const sorted = filtered.sort((a, b) =>
            (statusOrder[a[1].status] || 5) - (statusOrder[b[1].status] || 5)
        );

        for (const [key, h] of sorted) {
            const dotClass = h.status.toLowerCase().replace('_', '-');
            html += `
                <tr>
                    <td>${h.source}</td>
                    <td><span class="health-dot ${dotClass}"></span>${h.status}</td>
                    <td>${h.staleness_s != null ? formatAge(h.staleness_s) : 'N/A'}</td>
                    <td>${h.source_age_s != null ? formatAge(h.source_age_s) : 'N/A'}</td>
                    <td>${h.update_count}</td>
                    <td style="color: ${h.error_count > 0 ? '#EF4444' : 'inherit'};">${h.error_count}${h.last_error ? ' (' + truncate(h.last_error, 30) + ')' : ''}</td>
                    <td>${h.last_seen_utc ? h.last_seen_utc.substring(11, 19) : '--'}</td>
                </tr>`;
        }
        tbody.innerHTML = html;
    }

    // === Utilities ===
    function formatAge(seconds) {
        if (seconds == null || seconds === Infinity) return 'N/A';
        if (seconds < 60) return Math.round(seconds) + 's';
        if (seconds < 7200) return Math.round(seconds / 60) + 'm';
        const h = Math.floor(seconds / 3600);
        const m = Math.round((seconds % 3600) / 60);
        return m > 0 ? h + 'h ' + m + 'm' : h + 'h';
    }

    function formatAgeFriendly(seconds) {
        if (seconds == null || seconds === Infinity) return '';
        if (seconds < 60) return Math.round(seconds) + 's ago';
        if (seconds < 7200) {
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return m + 'min ' + (s > 0 ? s + 's' : '') + ' ago';
        }
        const h = Math.floor(seconds / 3600);
        const m = Math.round((seconds % 3600) / 60);
        return h + 'h ' + (m > 0 ? m + 'm ' : '') + 'ago';
    }

    function updateMetarLiveAge() {
        const el = document.getElementById('metar-age-live');
        if (!el || !metarObsTimeUtc) {
            if (el) el.textContent = '';
            return;
        }
        const nowUtc = new Date();
        const ageSec = (nowUtc.getTime() - metarObsTimeUtc.getTime()) / 1000;

        // Age classes with METAR cycle context:
        // fresh (< 2 min)  = new data just arrived (pulsing red)
        // recent (< 15 min) = recent observation (green)
        // aging (15-40 min) = mid-cycle, normal (yellow)
        // stale (40-70 min) = next METAR expected soon (orange)
        // normal (> 70 min) = overdue, possible NOAA delay (muted)
        if (ageSec < 120) {
            el.textContent = formatAgeFriendly(ageSec);
            el.className = 'metar-age-live fresh';
        } else if (ageSec < 900) {
            el.textContent = formatAgeFriendly(ageSec);
            el.className = 'metar-age-live recent';
        } else if (ageSec < 2400) {
            el.textContent = formatAgeFriendly(ageSec);
            el.className = 'metar-age-live aging';
        } else if (ageSec < 4200) {
            el.textContent = formatAgeFriendly(ageSec) + ' (next METAR soon)';
            el.className = 'metar-age-live stale';
        } else {
            el.textContent = formatAgeFriendly(ageSec) + ' (awaiting NOAA)';
            el.className = 'metar-age-live normal';
        }
    }

    function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }

    // === METAR History ===
    let lastHistoryStation = null;

    async function fetchMetarHistory() {
        if (!currentStation) return;
        try {
            const resp = await fetch(`/api/v2/world/metar_history/${currentStation}`, { cache: 'no-store' });
            const data = await resp.json();
            if (data.error) {
                document.getElementById('metar-history-content').innerHTML =
                    `<p style="color:#EF4444; font-size:13px;">${data.error}</p>`;
                return;
            }
            lastHistoryStation = currentStation;
            renderMetarHistory(data);
        } catch (err) {
            console.error('METAR history fetch error:', err);
        }
    }

    function renderMetarHistory(data) {
        const container = document.getElementById('metar-history-content');
        const countEl = document.getElementById('metar-history-count');
        const obs = data.observations || [];

        if (obs.length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No observations today yet.</p>';
            countEl.textContent = '0 obs';
            return;
        }

        countEl.textContent = obs.length + ' obs';

        // Find the max temp from NOAA history (source of truth for the full day)
        let maxRawF = -Infinity;
        let maxObs = null;
        for (const o of obs) {
            const tempRawF = Number(o.temp_f_raw);
            if (Number.isFinite(tempRawF) && tempRawF > maxRawF) {
                maxRawF = tempRawF;
                maxObs = o;
            }
        }

        // Update the Daily Max display in METAR card from NOAA history
        // (overrides the WorldState tracker which may be incomplete after restart)
        const dmRow = document.getElementById('daily-max-row');
        if (maxObs && dmRow) {
            const maxSettlement = usesCelsius()
                ? Math.round(Number(maxObs.temp_c))
                : Number(maxObs.temp_f);
            const maxRawDisplay = convertTempFromF(maxRawF);
            dmRow.style.display = 'flex';
            document.getElementById('daily-max-temp').textContent =
                Number.isFinite(maxSettlement) ? `${maxSettlement.toFixed(0)}${tempUnitSymbol()}` : '--';
            document.getElementById('daily-max-raw').textContent =
                Number.isFinite(maxRawDisplay) ? `Raw: ${maxRawDisplay.toFixed(1)}${tempUnitSymbol()}` : 'Raw: --';
            document.getElementById('daily-max-time').textContent =
                'at ' + maxObs.obs_time_local + ' ' + localTzLabel;
        }

        let html = `<table class="metar-history-table">
            <thead><tr>
                <th>${localTzLabel}</th>
                <th>ES</th>
                <th>Temp ${tempUnitSymbol()}</th>
            </tr></thead><tbody>`;

        // Render rows in reverse order (newest first)
        for (let i = obs.length - 1; i >= 0; i--) {
            const o = obs[i];
            const rawF = Number(o.temp_f_raw);
            const displayTemp = convertTempFromF(rawF);
            const isMax = Number.isFinite(rawF) && rawF === maxRawF;
            const rowClass = isMax ? ' class="is-max"' : '';
            const tempStyle = isMax ? ' style="color:#F97316; font-weight:700;"' : '';
            const esTime = formatTimeInTz(o.obs_time_utc, esTimeFormatter);

            html += `<tr${rowClass}>
                <td style="font-weight:600;">${o.obs_time_local}</td>
                <td>${esTime}</td>
                <td${tempStyle}>${Number.isFinite(displayTemp) ? displayTemp.toFixed(1) : '--'}${isMax ? ' *' : ''}</td>
            </tr>`;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // === Init ===
    async function init() {
        // Set up default formatters
        updateTimezoneFormatters();

        // Load stations for selector
        await loadStations();

        // Try SSE first
        connectSSE();

        // Also do an immediate fetch
        fetchSnapshot();

        // Fetch METAR history for today
        fetchMetarHistory();
        // Refresh METAR history every 60s
        setInterval(() => {
            if (currentStation !== lastHistoryStation) fetchMetarHistory();
        }, 5000);  // Check station change every 5s
        setInterval(fetchMetarHistory, 60000);  // Full refresh every 60s

        // Polling fallback: 15s when SSE active, 3s when disconnected
        setInterval(() => {
            if (sseConnected) return;  // SSE handles updates, skip poll
            fetchSnapshot();
        }, 3000);
        // Slow backup poll even when SSE is active (catch stale state)
        setInterval(fetchSnapshot, 15000);

        // Live age ticker - update every second
        setInterval(updateMetarLiveAge, 1000);

        // Force immediate refresh when tab becomes visible again
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                fetchSnapshot();
                updateMetarLiveAge();
                if (!evtSource || evtSource.readyState === EventSource.CLOSED) {
                    connectSSE();
                }
            }
        });
    }

    // Re-init icons after DOM update
    function refreshIcons() {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', () => {
        window.addEventListener('helios:stationchange', (event) => {
            const nextStation = event?.detail?.stationId;
            if (!nextStation || nextStation === currentStation) return;
            selectStation(nextStation);
        });
        init();
        refreshIcons();
    });
})();
</script>
{% endblock %}
