{% extends "base.html" %}

{% block title %}HELIOS - Nowcast Debug{% endblock %}

{% block head_extra %}
<style>
    .debug-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .debug-panel {
        background: var(--bg-secondary);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 20px;
    }

    .debug-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .debug-panel-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .debug-panel-title i {
        width: 18px;
        height: 18px;
        color: #8B5CF6;
    }

    /* State Table */
    .state-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .state-table tr {
        border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .state-table td {
        padding: 10px 0;
    }

    .state-table td:first-child {
        color: var(--text-muted);
        width: 160px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .state-table td:last-child {
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-main);
    }

    /* Component Breakdown */
    .component-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .component-name {
        flex: 1;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .component-value {
        font-size: 14px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
    }

    .component-value.positive { color: #10B981; }
    .component-value.negative { color: #EF4444; }
    .component-value.neutral { color: var(--text-main); }

    /* Health Status */
    .health-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .health-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }

    .health-source {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 6px;
    }

    .health-status {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
        display: inline-block;
    }

    .health-status.ok { background: rgba(16,185,129,0.2); color: #10B981; }
    .health-status.stale { background: rgba(244,208,63,0.2); color: #F4D03F; }
    .health-status.dead { background: rgba(239,68,68,0.2); color: #EF4444; }

    /* Bias History Chart */
    .bias-chart-container {
        height: 200px;
        position: relative;
    }

    /* Trigger Counts */
    .trigger-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .trigger-card {
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }

    .trigger-type {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
    }

    .trigger-count {
        font-size: 20px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--accent-blue);
    }

    /* QC Status */
    .qc-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
    }

    .qc-badge.ok {
        background: rgba(16,185,129,0.2);
        color: #10B981;
    }

    .qc-badge.uncertain {
        background: rgba(244,208,63,0.2);
        color: #F4D03F;
    }

    .qc-badge.outlier {
        background: rgba(239,68,68,0.2);
        color: #EF4444;
    }

    /* Station selector */
    .station-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .station-btn {
        padding: 8px 20px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .station-btn:hover {
        background: rgba(255,255,255,0.1);
    }

    .station-btn.active {
        background: rgba(139,92,246,0.2);
        border-color: #8B5CF6;
        color: #8B5CF6;
    }

    /* JSON Viewer */
    .json-viewer {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 15px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
        color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .debug-grid {
            grid-template-columns: 1fr;
        }
        .health-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <i data-lucide="bug" style="width:24px;height:24px;color:#8B5CF6;"></i>
        Nowcast Debug
    </div>
    <a href="/nowcast" style="font-size:13px;color:var(--text-muted);text-decoration:none;">
        <i data-lucide="arrow-left" style="width:14px;height:14px;"></i>
        Back to Nowcast
    </a>
</div>

<div class="page-content">
    <!-- Station Selector -->
    <div class="station-selector" id="station-selector">
        <!-- Populated by JS -->
    </div>

    <div class="debug-grid">
        <!-- Daily State -->
        <div class="debug-panel">
            <div class="debug-panel-header">
                <div class="debug-panel-title">
                    <i data-lucide="database"></i>
                    Daily State
                </div>
                <div class="qc-badge ok" id="qc-badge">
                    <i data-lucide="check-circle" style="width:14px;height:14px;"></i>
                    OK
                </div>
            </div>
            <table class="state-table" id="state-table">
                <tr><td>Station ID</td><td id="state-station">--</td></tr>
                <tr><td>Target Date</td><td id="state-date">--</td></tr>
                <tr><td>Max So Far (°F)</td><td id="state-max">--</td></tr>
                <tr><td>Last Obs Temp (°F)</td><td id="state-last-temp">--</td></tr>
                <tr><td>Bias (°F)</td><td id="state-bias">--</td></tr>
                <tr><td>Bias Observations</td><td id="state-bias-n">--</td></tr>
                <tr><td>Trend (°F/hr)</td><td id="state-trend">--</td></tr>
                <tr><td>Sigma (°F)</td><td id="state-sigma">--</td></tr>
                <tr><td>Update Count</td><td id="state-updates">--</td></tr>
                <tr><td>Last Update</td><td id="state-last-update">--</td></tr>
            </table>
        </div>

        <!-- Base Forecast -->
        <div class="debug-panel">
            <div class="debug-panel-header">
                <div class="debug-panel-title">
                    <i data-lucide="cloud"></i>
                    Base Forecast
                </div>
            </div>
            <table class="state-table">
                <tr><td>Model Source</td><td id="base-source">--</td></tr>
                <tr><td>T Max Base (°F)</td><td id="base-tmax">--</td></tr>
                <tr><td>T Peak Hour NYC (ES)</td><td id="base-peak-hour">--</td></tr>
            </table>

            <div style="margin-top:20px;">
                <div class="debug-panel-title" style="margin-bottom:10px;">
                    <i data-lucide="thermometer"></i>
                    Calculation Components
                </div>
                <div id="components-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <div class="debug-grid">
        <!-- Source Health -->
        <div class="debug-panel">
            <div class="debug-panel-header">
                <div class="debug-panel-title">
                    <i data-lucide="heart-pulse"></i>
                    Source Health
                </div>
            </div>
            <div class="health-grid" id="health-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Trigger Counts -->
        <div class="debug-panel">
            <div class="debug-panel-header">
                <div class="debug-panel-title">
                    <i data-lucide="zap"></i>
                    Trigger Counts
                </div>
            </div>
            <div class="trigger-grid" id="trigger-grid">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Raw JSON -->
    <div class="debug-panel">
        <div class="debug-panel-header">
            <div class="debug-panel-title">
                <i data-lucide="code"></i>
                Raw State JSON
            </div>
        </div>
        <div class="json-viewer" id="json-viewer">
            Loading...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let currentStation = 'KLGA';
    let pollInterval = null;

    async function init() {
        await loadStations();
        await loadDebugData();

        // Poll every 10 seconds for debug
        pollInterval = setInterval(loadDebugData, 10000);
    }

    async function loadStations() {
        try {
            const resp = await fetch('/api/stations');
            const stations = await resp.json();

            const container = document.getElementById('station-selector');
            container.innerHTML = '';

            for (const stn of stations) {
                const btn = document.createElement('button');
                btn.className = 'station-btn' + (stn.id === currentStation ? ' active' : '');
                btn.textContent = stn.id;
                btn.onclick = () => selectStation(stn.id);
                container.appendChild(btn);
            }
        } catch (e) {
            console.error('Failed to load stations:', e);
        }
    }

    function selectStation(stationId) {
        currentStation = stationId;
        document.querySelectorAll('.station-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === stationId);
        });
        loadDebugData();
    }

    async function loadDebugData() {
        try {
            // Load state
            const stateResp = await fetch(`/api/v3/nowcast/${currentStation}/state`);
            const stateData = await stateResp.json();

            // Load status
            const statusResp = await fetch('/api/v3/nowcast/status');
            const statusData = await statusResp.json();

            renderState(stateData);
            renderStatus(statusData);

            // Raw JSON
            document.getElementById('json-viewer').textContent =
                JSON.stringify(stateData, null, 2);

        } catch (e) {
            console.error('Failed to load debug data:', e);
        }
    }

    function renderState(data) {
        // Basic state
        document.getElementById('state-station').textContent = data.station_id || '--';
        document.getElementById('state-date').textContent = data.target_date || '--';
        document.getElementById('state-max').textContent =
            data.max_so_far_f !== undefined ? `${data.max_so_far_f.toFixed(1)}` : '--';
        document.getElementById('state-last-temp').textContent =
            data.last_obs_temp_f !== undefined ? `${data.last_obs_temp_f.toFixed(1)}` : '--';
        document.getElementById('state-bias').textContent =
            data.bias_f !== undefined ? `${data.bias_f >= 0 ? '+' : ''}${data.bias_f.toFixed(2)}` : '--';
        document.getElementById('state-bias-n').textContent = data.bias_observations || '--';
        document.getElementById('state-trend').textContent =
            data.trend_f_per_hour !== undefined ?
                `${data.trend_f_per_hour >= 0 ? '+' : ''}${data.trend_f_per_hour.toFixed(2)}` : '--';
        document.getElementById('state-sigma').textContent =
            data.sigma_f !== undefined ? `${data.sigma_f.toFixed(2)}` : '--';
        document.getElementById('state-updates').textContent = data.update_count || '--';
        if (data.last_update_utc) {
            const dt = new Date(data.last_update_utc);
            // Show NYC time (UTC-5)
            const nycTime = new Date(dt.getTime() - 5 * 60 * 60 * 1000);
            const esTime = new Date(dt.getTime() + 1 * 60 * 60 * 1000);
            const nycStr = nycTime.toISOString().substr(11, 8);
            const esStr = esTime.toISOString().substr(11, 8);
            document.getElementById('state-last-update').textContent = `${nycStr} NYC (${esStr} ES)`;
        } else {
            document.getElementById('state-last-update').textContent = '--';
        }

        // QC Badge
        const qcState = data.qc_state || 'OK';
        const qcBadge = document.getElementById('qc-badge');
        qcBadge.className = 'qc-badge ' + qcState.toLowerCase();
        qcBadge.innerHTML = `
            <i data-lucide="${qcState === 'OK' ? 'check-circle' : 'alert-triangle'}"
               style="width:14px;height:14px;"></i>
            ${qcState}
        `;
        lucide.createIcons();

        // Base Forecast
        if (data.base_forecast) {
            document.getElementById('base-source').textContent =
                data.base_forecast.source || '--';
            document.getElementById('base-tmax').textContent =
                data.base_forecast.t_max_base_f !== null ?
                    `${data.base_forecast.t_max_base_f.toFixed(1)}` : '--';
            const peakHourNyc = data.base_forecast.t_peak_hour;
            if (peakHourNyc !== null && peakHourNyc !== undefined) {
                const peakHourEs = (peakHourNyc + 6) % 24;
                document.getElementById('base-peak-hour').textContent =
                    `${peakHourNyc}:00 (${peakHourEs}:00)`;
            } else {
                document.getElementById('base-peak-hour').textContent = '--';
            }
        }

        // Source Health
        renderHealth(data.sources_health || {});
    }

    function renderHealth(sources) {
        const container = document.getElementById('health-grid');
        container.innerHTML = '';

        const entries = Object.entries(sources);
        if (entries.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted);font-size:12px;grid-column:span 3;">No sources tracked yet</div>';
            return;
        }

        for (const [source, status] of entries) {
            const card = document.createElement('div');
            card.className = 'health-card';
            card.innerHTML = `
                <div class="health-source">${source}</div>
                <div class="health-status ${status.toLowerCase()}">${status}</div>
            `;
            container.appendChild(card);
        }
    }

    function renderStatus(data) {
        // Trigger counts
        const container = document.getElementById('trigger-grid');
        container.innerHTML = '';

        const triggers = data.trigger_counts || {};
        for (const [trigger, count] of Object.entries(triggers)) {
            const card = document.createElement('div');
            card.className = 'trigger-card';
            card.innerHTML = `
                <div class="trigger-type">${trigger}</div>
                <div class="trigger-count">${count}</div>
            `;
            container.appendChild(card);
        }
    }

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (pollInterval) clearInterval(pollInterval);
    });

    document.addEventListener('DOMContentLoaded', init);
    lucide.createIcons();
})();
</script>
{% endblock %}
