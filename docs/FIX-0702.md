# FIX-0702: Fixes from PROPUESTA-0702

## Summary

This document covers all fixes implemented in response to `docs/PROPUESTA-0702.md`. The four steps were:
1. Fix market replay fidelity (`timesteps_with_market=0`)
2. Fix backtest UX (intraday drilldown instead of daily-only summary)
3. Normalize sizing rules ($1 minimum) and costs parity
4. Auto-learning calibration (nowcast params, probabilistic calibration, expanded grid, multi-objective promotion)

**All four steps are now implemented.**

---

## Step 1: Market Tape Integrity (Checklist A-C)

**What was broken:**
`timesteps_with_market=0` was reported in backtest results. Dates before 2026-02-01 had no `l2_snap` recordings (recorder not yet running). A minor inconsistency in `iterate_timeline()` only matched `"market"` and `"l2_snap"` but not `"l2_snap_1s"`.

**Changes made:**

1. **`core/backtest/dataset.py:214`** - Fixed channel matching in `iterate_timeline()` to use `ch in ("market", "l2_snap", "l2_snap_1s")`, matching `build_dataset()` at line 351.

2. **`core/backtest/dataset.py:356-372`** - Added diagnostic logging:
   - DEBUG: per-channel event counts for every dataset build
   - WARNING: when no market events found, with channels seen

**l2_snap data availability:**
| Date       | l2_snap events |
|------------|---------------|
| 2026-01-29 | 0 (no data)   |
| 2026-01-30 | 0 (no data)   |
| 2026-01-31 | 0 (no data)   |
| 2026-02-01 | 2,957         |
| 2026-02-02 | 31,556        |
| 2026-02-03 | 13,068        |
| 2026-02-04 | 20,814        |
| 2026-02-05 | 11,967        |

---

## Step 2: Backtest UI Intraday View (Checklist E)

**What was wrong:**
Frontend showed daily summary rows only. Backend already had full intraday `prediction_points` and `decision_points` but the UI didn't render them.

**Changes in `templates/backtest.html` (+800 lines):**
- Day detail drilldown panel (click day row to expand)
- Coverage stats cards (timeline steps, market %, nowcast %)
- Intraday tmax_mean chart with +/-1 sigma band (Chart.js)
- Actual tmax horizontal dashed line
- Buy/sell fill markers (green triangles, red inverted triangles)
- **p_bucket top-5 probability chart** showing how bucket probabilities evolve intraday, with actual winner starred
- Reason counters as chip/tag grid
- Fills blotter table (time, bucket, side, size, price, fees, type)
- Day row status badges (ok/integrity_warning/no_market_data)
- Coverage percentage bars in day table

---

## Step 3: Sizing and Cost Parity (Checklist D)

**What was broken:**
Paper broker had `min_buy_notional_usd=1.0`, backtest simulator had no minimum. Hard gate existed but lacked reason counter.

**Changes made:**

1. **`core/backtest/simulator.py`** (+25 lines)
   - `TakerModel.execute()`: added `min_order_usd` param; bumps size to meet $1 minimum
   - `ExecutionSimulator.__init__()`: added `min_order_usd=1.0` default
   - Maker order enforcement: same $1 minimum applied to passive orders

2. **`core/backtest/engine.py`**
   - `hard_gate_no_market` reason counter when signals blocked due to missing market data
   - `turnover_usd` field added to DayResult and BacktestResult
   - Aggregated as `total_turnover = sum(d.turnover_usd for d in day_results)`

**Fee/slippage parity (verified):**
Both backtest and paper broker use `ExecutionSimulator()` with identical defaults:
- Taker fee: 2%, base slippage: 0.5%
- Maker fee: 0% (rebate)
- Min order: $1.00

---

## Step 4: Auto-Learning Calibration

### 4a. Nowcast Parameter Auto-Calibration

**New file: `core/backtest/nowcast_calibrator.py`** (337 lines)

`NowcastCalibrator` replays recorded METAR observations through a fresh `NowcastEngine` with candidate `NowcastConfig` parameter sets, evaluating against ground truth (DayLabel) using composite loss = 0.5 * Brier + 0.5 * normalized MAE.

**Calibratable parameters** (DEFAULT_NOWCAST_GRID):
- `bias_decay_hours`: [4.0, 6.0, 8.0]
- `bias_alpha_normal`: [0.15, 0.2, 0.3, 0.4]
- `base_sigma_f`: [1.5, 2.0, 2.5]
- `sigma_qc_penalty_uncertain`: [0.3, 0.5, 0.7]
- `sigma_stale_source_penalty`: [0.2, 0.3, 0.5]

**Key design:**
- Grid search with random sampling when combos > `max_combinations`
- Uses DatasetBuilder.build_datasets_for_range() for train/val splits
- Filters to days with labels + world observations
- Returns `NowcastCalibrationResult` with best params + all results

### 4b. Probabilistic Calibration

**New file: `core/backtest/prob_calibrator.py`** (572 lines)

`ProbabilityCalibrator` corrects systematic bias in bucket probabilities:

- **Temperature Scaling**: optimize scalar T such that `softmax(logits / T)` minimizes NLL on calibration set. Uses scipy.optimize if available, falls back to grid search.
- **Isotonic Regression (PAV)**: pool-adjacent-violators algorithm, pure Python implementation. Non-parametric monotonic calibration.
- Supports `fit(predictions, labels)` → `calibrate(probs)` → calibrated probs
- `get_reliability_data()` for reliability diagram generation

Integrated into `CalibrationLoop.grid_search()` as a post-processing step.

### 4c. Expanded Grid Search + Strategy Parameters

**Modified: `core/backtest/calibration.py`** (+147 lines)

- Expanded DEFAULT_PARAMS with more ParameterSets covering edge thresholds, cooldowns, sizing rules
- `_run_with_params()` dynamically sets all PolicyTable fields
- `ObjectiveFunction` enhanced with `turnover_penalty` and `fill_rate_bonus`
- ProbabilityCalibrator wired in as post-processing step after grid search

### 4d. Multi-Objective Promotion

**Modified: `core/autotrader/learning.py`** (+55 lines)

New promotion thresholds in `LearningConfig`:
```python
min_val_pnl_net: float = -5.0       # Allow small losses
max_val_drawdown: float = 0.30      # Max 30% drawdown
max_val_turnover_ratio: float = 10.0  # Reasonable turnover cap
```

`_promotion_decision()` now checks ALL thresholds (val_score, PnL net, drawdown, turnover). Rejection reason lists all failed conditions.

**NowcastCalibrator wired into `run_once()`:**
- Phase A: Nowcast parameter calibration (up to 200 combos)
- Phase B: Policy/strategy calibration (CalibrationLoop grid search)
- Results merged: `best_params["nowcast"]` contains best nowcast config
- Artifact includes `nowcast_calibration` and `prob_calibrator` sections

### 4e. Updated Models and Exports

- **`core/autotrader/models.py`**: `LearningRunResult` has `val_pnl_net`, `val_max_drawdown`, `val_turnover_ratio` fields
- **`core/backtest/__init__.py`**: Exports `NowcastCalibrator`, `NowcastCalibrationResult`, `DEFAULT_NOWCAST_GRID`, `ProbabilityCalibrator`, `CalibrationParams`

---

## Files Changed (Complete List)

| File | Changes |
|------|---------|
| `core/backtest/dataset.py` | +20 lines: channel matching fix, diagnostic logging |
| `core/backtest/engine.py` | +10 lines: turnover_usd, hard_gate counter |
| `core/backtest/simulator.py` | +25 lines: min_order_usd enforcement |
| `core/backtest/calibration.py` | +147 lines: expanded grid, ObjectiveFunction, prob calibrator |
| `core/autotrader/learning.py` | +55 lines: multi-objective promotion, NowcastCalibrator wiring |
| `core/autotrader/models.py` | +7 lines: new metrics fields |
| `core/backtest/__init__.py` | +20 lines: new exports |
| `templates/backtest.html` | +800 lines: full intraday drilldown UI |

### New Files

| File | Lines | Description |
|------|-------|-------------|
| `core/backtest/nowcast_calibrator.py` | 337 | Nowcast parameter auto-calibration via replay |
| `core/backtest/prob_calibrator.py` | 572 | Temperature scaling + isotonic regression |

---

## What Was NOT Implemented (and why)

### Residual Correction Model (PROPUESTA Step 4, item 3)
The PROPUESTA suggests training a Ridge/GBDT model on prediction error residuals using features like wind, radiation, SST, etc. This was intentionally deferred because:
- Requires accumulation of sufficient historical data (months, not days)
- Needs feature engineering pipeline for the additional weather variables
- The nowcast calibration + probabilistic calibration cover the "low-hanging fruit" first

### Parquet Compaction of l2_snap
The l2_snap channel is in NDJSON format. Running the compactor would improve read performance for multi-day backtests. Not blocking, but recommended for longer date ranges.

---

## Verification Steps

1. **Market tape flows**: `GET /api/v5/backtest/day_detail/KLGA?date=2026-02-05` → `coverage.timesteps_with_market > 0`
2. **Hard gate works**: Backtest 2026-01-30 → `status="no_market_data"`, fills=0, pnl=0
3. **$1 minimum enforced**: All fills have `size * price >= 1.0`
4. **Intraday UI**: Click a day row → see tmax chart, p_bucket chart, fills blotter
5. **Learning pipeline**: `POST /api/v6/learning/run` → artifact has `nowcast_calibration` + `prob_calibrator` + multi-objective promotion decision
